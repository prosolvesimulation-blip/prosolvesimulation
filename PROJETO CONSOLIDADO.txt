================================================================================
ARQUIVOS DA RA√çZ DO PROJETO
================================================================================

--- ARQUIVO: consolidar_projeto.py ---
import os

def consolidar_projeto():
    # Defini√ß√£o dos caminhos
    root_dir = os.path.dirname(os.path.abspath(__file__))
    prosolve_dir = os.path.join(root_dir, 'prosolve')
    output_file = os.path.join(root_dir, 'PROJETO CONSOLIDADO.txt')
    
    # Extens√µes permitidas
    extens√µes_prosolve = ('.py', '.j2', '.js')
    extens√µes_raiz = ('.py')
    
    print(f"Iniciando consolida√ß√£o em: {output_file}")
    
    with open(output_file, 'w', encoding='utf-8') as outfile:
        # 1. Processar arquivos .py na raiz
        outfile.write("================================================================================\n")
        outfile.write("ARQUIVOS DA RA√çZ DO PROJETO\n")
        outfile.write("================================================================================\n\n")
        
        for file in os.listdir(root_dir):
            if file.endswith(extens√µes_raiz) and os.path.isfile(os.path.join(root_dir, file)):
                file_path = os.path.join(root_dir, file)
                outfile.write(f"--- ARQUIVO: {file} ---\n")
                try:
                    with open(file_path, 'r', encoding='utf-8') as infile:
                        outfile.write(infile.read())
                    outfile.write("\n\n")
                except Exception as e:
                    outfile.write(f"Erro ao ler arquivo: {e}\n\n")

        # 2. Processar pasta prosolve (recursivo)
        if os.path.exists(prosolve_dir):
            outfile.write("================================================================================\n")
            outfile.write("CONTE√öDO DA PASTA PROSOLVE\n")
            outfile.write("================================================================================\n\n")
            
            for root, dirs, files in os.walk(prosolve_dir):
                for file in files:
                    if file.endswith(extens√µes_prosolve):
                        file_path = os.path.join(root, file)
                        rel_path = os.path.relpath(file_path, root_dir)
                        outfile.write(f"--- ARQUIVO: {rel_path} ---\n")
                        try:
                            with open(file_path, 'r', encoding='utf-8') as infile:
                                outfile.write(infile.read())
                            outfile.write("\n\n")
                        except Exception as e:
                            outfile.write(f"Erro ao ler arquivo: {e}\n\n")
        else:
            outfile.write("\nPASTA 'prosolve' N√ÉO ENCONTRADA.\n")

    print("Projeto consolidado com sucesso!")

if __name__ == "__main__":
    consolidar_projeto()


--- ARQUIVO: explore_normals.py ---
import sys
import os
import json

try:
    import MEDLoader as ml
    import medcoupling as mc
except ImportError:
    print("MEDCOUPLING not found")
    sys.exit(1)

def explore(file_path):
    print(f"Checking {file_path}")
    mesh_names = ml.GetMeshNames(file_path)
    mesh_name = mesh_names[0]
    
    # Read just the shell group
    group_mesh = ml.ReadUMeshFromGroups(file_path, mesh_name, 0, ["12mm"])
    
    print(f"Mesh Dim: {group_mesh.getMeshDimension()}")
    print(f"Space Dim: {group_mesh.getSpaceDimension()}")
    
    # Look for normal/orthogonal computation methods
    methods = dir(group_mesh)
    relevant = [m for m in methods if 'Normal' in m or 'Orthogonal' in m or 'Measure' in m]
    print(f"Relevant Methods: {relevant}")
    
    # Try to compute normals
    try:
        # buildOrthogonalField is a common one
        if hasattr(group_mesh, 'buildOrthogonalField'):
            print("Trying buildOrthogonalField()...")
            normals = group_mesh.buildOrthogonalField()
            print(f"Result type: {type(normals)}")
            print(f"Number of tuples: {normals.getNumberOfTuples()}")
            print(f"Number of components: {normals.getNumberOfComponents()}")
            
            # Print sample
            arr = normals.toNumPyArray()
            print(f"Sample normal (0): {arr[0]}")
    except Exception as e:
        print(f"Error computing normals: {e}")

explore(r"c:\Users\jorge\OneDrive\ProSolveSimulation\test01\shell.med")


--- ARQUIVO: med_extractor.py ---
#!/usr/bin/env python3
"""MedExtractor: extract a MED mesh and emit a standardized JSON payload.

This module is designed to be agnostic to the frontend framework. It always
produces a JSON object on stdout (minified) and can optionally write the same
payload to a JSON file when a second argument is provided.
"""

import json
import os
import sys

try:
    # MEDCoupling Python bindings
    from medcoupling import MEDLoader  # type: ignore
except Exception:
    MEDLoader = None  # pragma: no cover - will trigger fallback errors if used without MED


def _safe_call(obj, method, default=None):
    """Call a method defensively if available."""
    if obj is None:
        return default
    if hasattr(obj, method):
        try:
            return getattr(obj, method)()
        except Exception:
            return default
    return default


def _category_from_dim(dim: int) -> str:
    if dim == 3:
        return "3D"
    if dim == 2:
        return "2D"
    if dim == 1:
        return "1D"
    # 0 or Node-like
    return "Node"


def _load_mesh(path: str):
    if MEDLoader is None:
        raise RuntimeError("medcoupling is not available in this environment.")
    loader = MEDLoader()
    # Try common entry points used by different MEDLoader bindings
    for method in ("LoadMesh", "LoadFile", "Load", "loadMesh", "loadFile", "load"):
        if hasattr(loader, method):
            func = getattr(loader, method)
            return func(path)
    raise RuntimeError("MEDLoader does not expose a compatible load method.")


def _extract_one_group(mesh, group_key: str) -> dict:
    # Try to determine mesh dimension
    dim = _safe_call(mesh, "getMeshDimension", 0)
    if not isinstance(dim, int):
        dim = int(dim) if dim is not None else 0
    category = _category_from_dim(dim)

    # Count (number of cells/elements)
    count = _safe_call(mesh, "getNumberOfElements", 0)
    if not isinstance(count, int):
        count = int(count) if count is not None else 0

    # Geometry: points, connectivity
    points = []
    connectivity = []
    normals = None

    try:
        coords = mesh.getCoords()
        if coords is not None and hasattr(coords, "toNumPyArray"):
            points = coords.toNumPyArray().flatten().tolist()
        elif coords is not None and hasattr(coords, "toList"):
            points = list(coords.toList())
    except Exception:
        points = []

    try:
        conn = mesh.getNodalConnectivity()
        if conn is not None and hasattr(conn, "toNumPyArray"):
            connectivity = conn.toNumPyArray().flatten().tolist()
        elif conn is not None and hasattr(conn, "toList"):
            connectivity = list(conn.toList())
    except Exception:
        connectivity = []

    # Normals for 2D meshes
    if category == "2D":
        try:
            orth = mesh.buildOrthogonalField()
            if orth is not None:
                arr = orth.getArray() if hasattr(orth, "getArray") else None
                if arr is not None and hasattr(arr, "toNumPyArray"):
                    normals = arr.toNumPyArray().flatten().tolist()
        except Exception:
            normals = None

    # VTK cell type (best-effort; default to Triangle=5 as per doc)
    type_vtk = 5
    for method in ("getVTKCellType", "getTypeVTK", "getCellType"):
        if hasattr(mesh, method):
            try:
                val = getattr(mesh, method)()
                if isinstance(val, int):
                    type_vtk = val
                    break
            except Exception:
                pass

    group = {
        "dimension": dim,
        "count": count,
        "category": category,
        "type_vtk": int(type_vtk),
        "points": points,
        "connectivity": connectivity,
        "normals": normals,
    }
    return group


def extract_to_dict(path: str):
    """Return the parsed MED data as a standard JSON-like dict.

    The result matches the schema defined in the mission protocol.
    """
    filename = os.path.basename(path)
    group_name = os.path.splitext(filename)[0] or "mesh"

    mesh = _load_mesh(path)
    # If the mesh exposes multiple groups, try to fetch them; otherwise create a single synthetic group
    groups = {}
    try:
        # Try to retrieve named groups using a couple of common API aliases
        group_names = []
        for attr in ("getGroupsNames", "getGroupsName", "getGroupNames"):
            if hasattr(mesh, attr):
                try:
                    names = getattr(mesh, attr)()
                    if isinstance(names, (list, tuple)):
                        group_names = list(names)
                        break
                except Exception:
                    pass
        if not group_names:
            group_names = [group_name]
    except Exception:
        group_names = [group_name]

    # Build data for the first available group (fallbacks handle missing per-group APIs)
    for g in group_names:
        groups[g] = _extract_one_group(mesh, g)

        # If we only discovered a synthetic group, break after first one
        # (the current frontend schema expects at least one group per file)
        break

    data = {"groups": groups}
    payload = {"status": "success", "filename": filename, "data": data}
    return payload


def main():
    if len(sys.argv) < 2:
        print("Usage: med_extractor.py <path_to_med> [output.json]", flush=True)
        sys.exit(2)
    path = sys.argv[1]
    outpath = sys.argv[2] if len(sys.argv) > 2 else None
    payload = None
    try:
        payload = extract_to_dict(path)
    except Exception as exc:
        payload = {"status": "error", "message": str(exc)}

    json_text = json.dumps(payload, separators=(",", ":"))
    # Always print to stdout (minified)
    print(json_text)
    if outpath:
        with open(outpath, "w", encoding="utf-8") as f:
            f.write(json_text)


if __name__ == "__main__":
    main()


--- ARQUIVO: test_med_groups_v2.py ---
import sys
import os

try:
    from MEDLoader import GetMeshNames, GetMeshGroupsNames, ReadUMeshFromGroups
    import medcoupling as mc
    
    file_path = r"c:\Users\jorge\OneDrive\ProSolveSimulation\test01\beam.med"
    print(f"Testing with: {file_path}")
    
    mesh_names = GetMeshNames(file_path)
    print(f"Meshes: {mesh_names}")
    
    if mesh_names:
        mesh_name = mesh_names[0]
        groups = GetMeshGroupsNames(file_path, mesh_name)
        print(f"Groups: {groups}")
        
        for g in groups:
            # Read mesh subset for this group
            # ReadUMeshFromGroups(fileName, meshName, iteration=0, groupNames=[])
            mesh_group = ReadUMeshFromGroups(file_path, mesh_name, 0, [g])
            print(f"Group '{g}': {mesh_group.getNumberOfCells()} cells, Type: {mesh_group.getMeshDimension()}D")
            
except Exception as e:
    print(f"Error: {e}")
    import traceback
    traceback.print_exc()


--- ARQUIVO: test_normals.py ---
import subprocess
import json

med_dir = r"c:\Users\jorge\OneDrive\ProSolveSimulation\MEDCOUPLING-9.15.0\MEDCOUPLING-9.15.0"
extractor = r"c:\Users\jorge\OneDrive\ProSolveSimulation\backend\services\med_extractor.py"
target = r"c:\Users\jorge\OneDrive\ProSolveSimulation\test01\shell.med"

cmd = f'cmd /c "cd /d {med_dir} && call env_launch.bat && python {extractor} {target}"'
print(f"Testing normal extraction on {target}...")
res = subprocess.run(cmd, capture_output=True, text=True, shell=True)

if res.returncode == 0:
    out = res.stdout.strip()
    lines = out.split('\n')
    data = None
    for line in reversed(lines):
        if line.strip().startswith('{'):
            try:
                data = json.loads(line)
                break
            except: continue
    
    if data and data['status'] == 'success':
        print(f"‚úì Groups found: {list(data['cells'].keys())}")
        for k, v in data['cells'].items():
            has_normals = 'normals' in v
            normal_count = len(v['normals']) if has_normals else 0
            print(f"  - {k}: {v['count']} cells, normals: {has_normals} ({normal_count})")
            if has_normals and normal_count > 0:
                print(f"    Sample normal[0]: {v['normals'][0]}")
    else:
        print("Failed to parse JSON")
        print(res.stdout)
else:
    print(res.stderr)


--- ARQUIVO: verify_med_extrusion_v2.py ---
import sys
import os
import json
import subprocess

def verify():
    base_dir = r"c:\Users\jorge\OneDrive\ProSolveSimulation"
    med_dir = os.path.join(base_dir, "MEDCOUPLING-9.15.0", "MEDCOUPLING-9.15.0")
    extractor_path = os.path.join(base_dir, "backend", "services", "med_extractor.py")
    shell_med = os.path.join(base_dir, "testcases", "shell", "shell.med")
    
    # 1. Create temporary geometries JSON
    geometries = [
        {
            "group": "group_shell",
            "type": "COQUE_3D",
            "section_params": {
                "thickness": 10.0,
                "offset": 0.0
            }
        }
    ]
    
    geom_json_path = os.path.join(base_dir, "temp", "geometries_verify_v2.json")
    os.makedirs(os.path.dirname(geom_json_path), exist_ok=True)
    with open(geom_json_path, 'w') as f:
        json.dump(geometries, f)
        
    print(f"Testing extrusion with {shell_med}")
    
    # 2. Call extractor
    cmd = f'cmd /c "cd /d {med_dir} && call env_launch.bat && python {extractor_path} \"{shell_med}\" \"{geom_json_path}\""'
    result = subprocess.run(cmd, capture_output=True, text=True, shell=True)
    
    if result.stderr:
        print("--- STDERR ---")
        print(result.stderr)
        print("--------------")

    # 3. Parse output
    output = result.stdout.strip()
    lines = output.split('\n')
    data = None
    for line in reversed(lines):
        line = line.strip()
        if line.startswith('{') and line.endswith('}'):
            try:
                data = json.loads(line)
                break
            except: continue
            
    if not data:
        print("FAILED: No JSON found in output")
        return
        
    # 4. Assertions
    cells = data.get("cells", {})
    print(f"Groups found: {list(cells.keys())}")
    
    if "group_shell_EXTRUDED" in cells:
        ext_data = cells["group_shell_EXTRUDED"]
        print(f"SUCCESS: 'group_shell_EXTRUDED' found!")
        print(f"  - Type: {ext_data.get('type')} (Expected: quad/triangle)")
        print(f"  - Cell count: {ext_data.get('count')}")
        
        # Check coordinates length to see if points were accumulated correctly
        points = data.get("points", [])
        print(f"Total points in master list: {len(points)}")
        
        # Verify first connectivity of a non-extruded group to see if offset is correct
        if "Group_Of_All_Faces" in cells:
            f_conn = cells["Group_Of_All_Faces"]["connectivity"][0]
            print(f"Sample Face Connectivity: {f_conn}")
            # If offset bug is fixed, points should be within range of that group's points
    else:
        print("FAILED: 'group_shell_EXTRUDED' not found in result.")

if __name__ == "__main__":
    verify()


================================================================================
CONTE√öDO DA PASTA PROSOLVE
================================================================================

--- ARQUIVO: prosolve\GemetryConfig.js ---
// =========================================================
// ARQUIVO: GeometryConfig.js
// =========================================================

const React = window.React || require('react');
const { useState, useEffect, useRef, useCallback } = React;

const API_BASE = 'http://localhost:5000/api';

// --- 1. VISUALIZADOR ---
const SectionVisualizer = ({ imageSrc, loading, error }) => {
    if (loading) return (
        <div className="w-full h-full flex flex-col items-center justify-center bg-white">
            <span className="text-3xl mb-2 animate-spin">‚öôÔ∏è</span>
            <span className="text-xs font-mono uppercase tracking-widest text-slate-400">Processing...</span>
        </div>
    );
    if (error) return (
        <div className="w-full h-full flex flex-col items-center justify-center bg-white text-red-500 p-4 text-center">
            <span className="text-3xl mb-2">‚ö†Ô∏è</span>
            <span className="text-xs">{error}</span>
        </div>
    );
    if (!imageSrc) return (
        <div className="w-full h-full flex flex-col items-center justify-center bg-white text-slate-300 select-none">
            <span className="text-5xl mb-3 opacity-20">üìê</span>
            <span className="text-xs font-bold uppercase tracking-widest">No Geometry</span>
        </div>
    );
    return (
        <div className="w-full h-full flex items-center justify-center bg-white overflow-hidden relative">
            <img src={imageSrc} alt="Preview" className="max-w-full max-h-full object-contain" />
            <div className="absolute top-2 left-2 flex flex-col gap-1 pointer-events-none">
                <div className="flex items-center gap-1 bg-white/90 px-1.5 py-0.5 rounded border border-blue-200 shadow-sm">
                    <span className="w-2 h-2 text-blue-600 font-bold">x</span>
                    <span className="text-[9px] text-slate-600 font-bold">Node (0,0)</span>
                </div>
                <div className="flex items-center gap-1 bg-white/90 px-1.5 py-0.5 rounded border border-red-200 shadow-sm">
                    <span className="w-2 h-2 text-red-500 font-bold">+</span>
                    <span className="text-[9px] text-slate-600 font-bold">Centroid</span>
                </div>
                <div className="flex items-center gap-1 bg-white/90 px-1.5 py-0.5 rounded border border-red-400 border-dashed shadow-sm">
                    <span className="w-4 border-t-2 border-red-500 border-dotted h-0"></span>
                    <span className="text-[9px] text-slate-600 font-bold">Offset</span>
                </div>
            </div>
        </div>
    );
};

// --- 2. CONFIGURADOR ---
const GeometryConfig = () => {
    const [geometries, setGeometries] = useState([]);
    const [library, setLibrary] = useState([]);
    const [selectedIdx, setSelectedIdx] = useState(0);
    const [loading, setLoading] = useState(true);
    
    // Results
    const [sectionImage, setSectionImage] = useState(null);
    const [calculatedProps, setCalculatedProps] = useState(null);
    const [calcLoading, setCalcLoading] = useState(false);
    const [calcError, setCalcError] = useState(null);
    
    const [autoCalc, setAutoCalc] = useState(true);
    const [splitRatio, setSplitRatio] = useState(55);
    const containerRef = useRef(null);
    const isResizing = useRef(false);
    const debounceTimer = useRef(null);

    // BEAM DEFAULTS
    const PROFILE_TYPES = {
        'RECTANGLE': { label: 'Solid Rectangle', default: { hy: 100, hz: 50, offset_y: 0, offset_z: 0, rotation: 0 } },
        'BOX':       { label: 'Rectangular Tube', default: { hy: 100, hz: 50, t: 5, offset_y: 0, offset_z: 0, rotation: 0 } },
        'CIRCLE':    { label: 'Solid Circle', default: { r: 50, offset_y: 0, offset_z: 0, rotation: 0 } },
        'TUBE':      { label: 'Circular Tube', default: { r: 50, t: 5, offset_y: 0, offset_z: 0, rotation: 0 } },
        'I_SECTION': { label: 'I-Section', default: { h: 200, tw: 6.3, bf_top: 100, tf_top: 8, bf_bot: 100, tf_bot: 8, offset_y: 0, offset_z: 0, rotation: 0 } }
    };

    // SHELL DEFAULTS (VECTEUR Default = 1,0,0 que √© o padr√£o do Aster se omitido, mas aqui deixamos explicito)
    const SHELL_DEFAULT = { thickness: 10.0, offset: 0.0, vx: 1.0, vy: 0.0, vz: 0.0 };

    // Load Data
    useEffect(() => {
        const load = async () => {
            try {
                const resp = await fetch('section.json');
                if (resp.ok) setLibrary(await resp.json());
            } catch (e) {}

            const globalGeoms = window.projectState?.geometries || [];
            const initialized = globalGeoms

                .filter(g => {
                    // Se category n√£o existir, tenta inferir, mas idealmente j√° vem correta
                    const cat = g._category || (g.type.includes('POU') ? '1D' : '3D');
                    return cat === '1D' || cat === '2D';
                })

                .map(g => {
                    const isBeam = g.type.includes('POU') || g.type.includes('BARRE') || g.type.includes('1D');
                    const isShell = g.type.includes('DKT') || g.type.includes('DST') || g.type.includes('COQUE');
                
                let params = {};
                
                if (isBeam) {
                    params = { ...PROFILE_TYPES['I_SECTION'].default, ...(g.section_params || {}) };
                } else if (isShell) {
                    // Se j√° tiver params, usa. Se n√£o, usa o default de Shell.
                    params = { ...SHELL_DEFAULT, ...(g.section_params || {}) };
                }

                return {
                    ...g,
                    section_type: g.section_type || (isBeam ? 'I_SECTION' : 'SHELL'),
                    profile_name: g.profile_name || 'Custom',
                    section_params: params,
                    // Mantendo compatibilidade legada se necess√°rio, mas preferindo section_params
                    thickness: g.thickness || "10", 
                    offset: g.offset || "0"
                };
            });
            setGeometries(initialized);
            setLoading(false);
        };
        load();
    }, []);

    // Sync Global
    useEffect(() => {
        if(window.projectState && geometries.length > 0) window.projectState.geometries = geometries;
    }, [geometries]);

    // API Call
    const calculateSection = async () => {
        if (geometries.length === 0) return;
        const selected = geometries[selectedIdx];
        const isBeam = selected.type.includes('POU') || selected.type.includes('BARRE') || selected.type.includes('1D');

        if (!isBeam) { setSectionImage(null); setCalculatedProps(null); return; }

        setCalcLoading(true);
        setCalcError(null);
        try {
            const response = await fetch(`${API_BASE}/calculate_section`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: selected.section_type, params: selected.section_params })
            });
            const data = await response.json();
            if (data.status === 'success') {
                setSectionImage(data.image);
                setCalculatedProps(data.properties);
            } else {
                throw new Error(data.message);
            }
        } catch (e) {
            setCalcError("Error: " + e.message);
        } finally {
            setCalcLoading(false);
        }
    };

    // Auto Trigger
    useEffect(() => {
        if (geometries.length === 0) return;
        const selected = geometries[selectedIdx];
        const isBeam = selected && (selected.type.includes('POU') || selected.type.includes('BARRE') || selected.type.includes('1D'));
        
        if (isBeam && autoCalc) {
            if (debounceTimer.current) clearTimeout(debounceTimer.current);
            debounceTimer.current = setTimeout(() => { calculateSection(); }, 800);
        }
    }, [selectedIdx, geometries, autoCalc]);

    // Handlers
    const updateGeometry = (idx, field, val) => setGeometries(prev => prev.map((g, i) => i === idx ? { ...g, [field]: val } : g));
    const handleParamEdit = (idx, k, v) => setGeometries(prev => prev.map((g, i) => i === idx ? { ...g, profile_name: 'Custom', section_params: { ...g.section_params, [k]: v } } : g));
    const handleSectionTypeChange = (idx, v) => setGeometries(prev => prev.map((g, i) => i === idx ? { ...g, section_type: v, profile_name: 'Custom', section_params: { ...PROFILE_TYPES[v].default } } : g));
    const handleProfileSelect = (idx, v) => {
        if(v==='Custom') { updateGeometry(idx, 'profile_name', 'Custom'); return; }
        const lib = library.find(l => l.name === v);
        if(lib) setGeometries(prev => prev.map((g, i) => i === idx ? { ...g, profile_name: lib.name, section_type: lib.type, 
            section_params: { ...Object.fromEntries(Object.entries(lib.params).map(([k,v])=>[k,String(v)])), offset_y: 0, offset_z: 0, rotation: 0 } 
        } : g));
    };

    // Resizer Logic
    const handleMouseDown = () => { isResizing.current = true; document.body.style.cursor = 'col-resize'; };
    const handleMouseUp = () => { isResizing.current = false; document.body.style.cursor = ''; };
    const handleMouseMove = useCallback((e) => {
        if (!isResizing.current || !containerRef.current) return;
        const rect = containerRef.current.getBoundingClientRect();
        let w = ((e.clientX - rect.left) / rect.width) * 100;
        if (w < 30) w = 30; if (w > 70) w = 70;
        setSplitRatio(w);
    }, []);
    useEffect(() => {
        window.addEventListener('mouseup', handleMouseUp);
        window.addEventListener('mousemove', handleMouseMove);
        return () => { window.removeEventListener('mouseup', handleMouseUp); window.removeEventListener('mousemove', handleMouseMove); };
    }, [handleMouseMove]);

    if (loading) return <div className="p-10 text-blue-500 animate-pulse">Loading...</div>;
    if (geometries.length === 0) return <div className="p-10 text-slate-500">No Groups Found</div>;

    const selected = geometries[selectedIdx] || geometries[0];
    const isBeam = selected.type.includes('POU') || selected.type.includes('BARRE') || selected.type.includes('1D');
    const isShell = selected.type.includes('DKT') || selected.type.includes('DST') || selected.type.includes('COQUE');
    const filteredLibrary = library.filter(lib => lib.type === selected.section_type);

    return (
        <div className="flex h-full w-full bg-slate-950 text-slate-200 text-sm overflow-hidden border-t border-slate-900 font-sans">
            
            {/* SIDEBAR */}
            <div className="w-56 border-r border-slate-800 bg-slate-950 flex flex-col shrink-0">
                <div className="h-10 border-b border-slate-800 flex items-center px-4 bg-slate-950 shrink-0">
                    <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Mesh Groups</span>
                </div>
                <div className="flex-1 overflow-y-auto custom-scrollbar">
                    {geometries.map((geo, idx) => (
                        <div key={idx} onClick={() => setSelectedIdx(idx)}
                             className={`px-4 py-3 border-b border-slate-800/50 cursor-pointer flex justify-between items-center transition-colors ${selectedIdx === idx ? 'bg-blue-600/10 border-l-2 border-l-blue-500 text-white' : 'hover:bg-slate-900 text-slate-400 border-l-2 border-l-transparent'}`}>
                            <span className="text-xs font-medium truncate w-28" title={geo.group}>{geo.group}</span>
                            <span className="text-[9px] font-mono text-slate-500">{geo.type}</span>
                        </div>
                    ))}
                </div>
            </div>

            {/* SPLIT AREA */}
            <div className="flex-1 flex overflow-hidden relative" ref={containerRef}>
                
                {/* PAINEL INPUTS */}
                <div style={{ width: `${splitRatio}%` }} className="flex flex-col border-r border-slate-800 bg-slate-900 h-full min-w-[350px]">
                    <div className="h-12 border-b border-slate-800 flex items-center justify-between px-4 bg-slate-900 shrink-0">
                        <div className="flex items-center gap-2">
                             <div className="w-1.5 h-1.5 rounded-full bg-blue-500"></div>
                             <span className="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Definition</span>
                             <span className="text-[10px] text-slate-500 font-mono bg-slate-800 px-2 py-0.5 rounded border border-slate-700 ml-2">{selected.group}</span>
                        </div>
                        {isBeam && (
                            <div className="flex items-center gap-3">
                                <div className="flex items-center gap-2 cursor-pointer group select-none" onClick={() => setAutoCalc(!autoCalc)} title="Automatic Calculation">
                                    <span className={`text-[9px] font-bold uppercase transition-colors ${autoCalc ? 'text-green-500' : 'text-slate-500'}`}>Auto</span>
                                    <div className={`w-8 h-4 rounded-full p-0.5 transition-colors border border-slate-700 ${autoCalc ? 'bg-green-900/50' : 'bg-slate-800'}`}>
                                        <div className={`w-3 h-3 bg-white rounded-full shadow transition-transform ${autoCalc ? 'translate-x-4 bg-green-400' : 'translate-x-0 bg-slate-400'}`}></div>
                                    </div>
                                </div>
                                <button onClick={calculateSection} disabled={calcLoading} className={`px-2 py-1 rounded text-[9px] font-bold uppercase tracking-wide border transition-all active:scale-95 flex items-center gap-1 ${autoCalc ? 'bg-slate-800 text-slate-500 border-slate-700 cursor-not-allowed opacity-50' : 'bg-blue-600 hover:bg-blue-500 text-white border-blue-500 shadow-lg'}`}>CALCULATE</button>
                            </div>
                        )}
                        {/* Shell n√£o tem c√°lculo de se√ß√£o 2D */}
                    </div>

                    <div className="flex-1 overflow-y-auto p-6 space-y-6 custom-scrollbar">
                        {/* --- CONFIGURA√á√ÉO DE VIGAS (BEAMS) --- */}
                        {isBeam && (
                            <>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-[10px] font-bold text-blue-400 uppercase mb-1.5 block">Profile Type</label>
                                        <select className="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded p-2.5 outline-none focus:border-blue-500"
                                            value={selected.section_type || 'I_SECTION'} onChange={(e) => handleSectionTypeChange(selectedIdx, e.target.value)}>
                                            {Object.entries(PROFILE_TYPES).map(([k, v]) => <option key={k} value={k}>{v.label}</option>)}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-500 uppercase mb-1.5 block">Library Preset</label>
                                        <select className="w-full bg-slate-950 border border-slate-700 text-slate-200 text-xs rounded p-2.5 outline-none focus:border-blue-500"
                                            value={selected.profile_name || 'Custom'} onChange={(e) => handleProfileSelect(selectedIdx, e.target.value)}>
                                            <option value="Custom">-- Custom --</option>
                                            {filteredLibrary.length > 0 && <optgroup label="Library">{filteredLibrary.map(l => <option key={l.id} value={l.name}>{l.name}</option>)}</optgroup>}
                                        </select>
                                    </div>
                                </div>

                                <div className="mt-4">
                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-2 block border-b border-slate-800 pb-1">Dimensions & Position (mm / deg)</label>
                                    <div className="grid grid-cols-2 gap-x-4 gap-y-3">
                                        {Object.entries(selected.section_params || {}).map(([k, v]) => {
                                            // Estiliza√ß√£o condicional dos inputs
                                            const isOffset = k.includes('offset');
                                            const isRotation = k === 'rotation';
                                            
                                            let badgeClass = 'bg-slate-800 border-slate-700 text-slate-400';
                                            let inputClass = 'border-slate-700 focus:border-blue-500';
                                            let labelText = k;

                                            if (isOffset) {
                                                badgeClass = 'bg-purple-900/30 border-purple-800 text-purple-400';
                                                inputClass = 'border-purple-800 focus:border-purple-500';
                                                labelText = k.replace('offset_', 'off_');
                                            } else if (isRotation) {
                                                badgeClass = 'bg-orange-900/30 border-orange-800 text-orange-400';
                                                inputClass = 'border-orange-800 focus:border-orange-500';
                                                labelText = 'rot¬∞';
                                            }

                                            return (
                                                <div key={k} className="relative group">
                                                    <div className={`absolute inset-y-0 left-0 w-16 rounded-l border-y border-l flex items-center justify-center text-[9px] font-bold pointer-events-none uppercase ${badgeClass}`}>
                                                        {labelText}
                                                    </div>
                                                    <input type="text" className={`w-full bg-slate-900 border text-white text-sm rounded pl-20 pr-2 py-1.5 outline-none font-mono transition-all ${inputClass}`}
                                                        value={v} onChange={(e) => handleParamEdit(selectedIdx, k, e.target.value)} />
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* TABELA DE PROPRIEDADES COMPLETA */}
                                {calculatedProps && (
                                    <div className="mt-8 pt-4 border-t border-slate-800 animate-in fade-in slide-in-from-bottom-2">
                                        <div className="flex justify-between items-center mb-3">
                                            <label className="text-[10px] font-bold text-green-500 uppercase flex items-center gap-2">
                                                <span>‚úì</span> Calculated Properties
                                            </label>
                                            <span className="text-[9px] text-slate-500">Full Analysis Report</span>
                                        </div>
                                        
                                        <div className="space-y-4">
                                            {/* GRUPO 1: Geometria B√°sica */}
                                            <div>
                                                <div className="text-[9px] font-bold text-slate-400 uppercase mb-1 border-b border-slate-800 pb-0.5">Basic Geometry</div>
                                                <div className="grid grid-cols-2 gap-1.5">
                                                    <PropRow label="Area (A)" value={calculatedProps["Area (A)"]} />
                                                    <PropRow label="Centroid Y" value={calculatedProps["Centroid Y (cy)"]} color="text-yellow-300" />
                                                    <PropRow label="Centroid Z" value={calculatedProps["Centroid Z (cx)"]} color="text-yellow-300" />
                                                    <PropRow label="Stat. Mom Qy (0,0)" value={calculatedProps["Static Moment Qy (at 0,0)"]} color="text-slate-400" />
                                                    <PropRow label="Stat. Mom Qz (0,0)" value={calculatedProps["Static Moment Qz (at 0,0)"]} color="text-slate-400" />
                                                </div>
                                            </div>

                                            {/* GRUPO 2: Rigidez Nodal (Global 0,0) - Steiner agora √© nativo */}
                                            <div>
                                                <div className="flex justify-between items-end mb-1 border-b border-slate-800 pb-0.5">
                                                    <span className="text-[9px] font-bold text-purple-400 uppercase">Global Stiffness (at Node 0,0)</span>
                                                </div>
                                                <div className="grid grid-cols-2 gap-1.5">
                                                    <PropRow label="Iyy (Node)" value={calculatedProps["Iyy (Node 0,0)"]} highlight />
                                                    <PropRow label="Izz (Node)" value={calculatedProps["Izz (Node 0,0)"]} highlight />
                                                    <PropRow label="Iyz (Node)" value={calculatedProps["Iyz (Node 0,0)"]} highlight />
                                                </div>
                                            </div>

                                            {/* GRUPO 3: Rigidez Local (Centroidal) */}
                                            <div>
                                                <div className="text-[9px] font-bold text-blue-400 uppercase mb-1 border-b border-slate-800 pb-0.5">Section Stiffness (Centroidal)</div>
                                                <div className="grid grid-cols-2 gap-1.5">
                                                    <PropRow label="Iyy (Local)" value={calculatedProps["Iyy (Local)"]} />
                                                    <PropRow label="Izz (Local)" value={calculatedProps["Izz (Local)"]} />
                                                    <PropRow label="Iyz (Local)" value={calculatedProps["Iyz (Local)"]} />
                                                    <PropRow label="Angle (deg)" value={calculatedProps["Angle (deg)"]} />
                                                    <PropRow label="I1 (Principal)" value={calculatedProps["I1 (Principal)"]} color="text-blue-200" />
                                                    <PropRow label="I2 (Principal)" value={calculatedProps["I2 (Principal)"]} color="text-blue-200" />
                                                </div>
                                            </div>

                                            {/* GRUPO 4: Tor√ß√£o e Cisalhamento */}
                                            <div>
                                                <div className="text-[9px] font-bold text-slate-500 uppercase mb-1 border-b border-slate-800 pb-0.5">Torsion & Shear</div>
                                                <div className="grid grid-cols-2 gap-1.5">
                                                    <PropRow label="J (Torsion)" value={calculatedProps["Torsion J"]} />
                                                    <PropRow label="Iw (Warping)" value={calculatedProps["Warping Iw"]} />
                                                    <PropRow label="Ay (Shear)" value={calculatedProps["Shear Area Ay"]} />
                                                    <PropRow label="Az (Shear)" value={calculatedProps["Shear Area Az"]} />
                                                </div>
                                            </div>

                                            {/* GRUPO 5: Resist√™ncia (Moduli) e Outros */}
                                            <div>
                                                <div className="text-[9px] font-bold text-slate-500 uppercase mb-1 border-b border-slate-800 pb-0.5">Strength & Others</div>
                                                <div className="grid grid-cols-2 gap-1.5">
                                                    <PropRow label="Wy (Elastic)" value={calculatedProps["Elastic Mod. Wy (Zxx)"]} />
                                                    <PropRow label="Wz (Elastic)" value={calculatedProps["Elastic Mod. Wz (Zyy)"]} />
                                                    <PropRow label="Zy (Plastic)" value={calculatedProps["Plastic Mod. Zy (Sxx)"]} />
                                                    <PropRow label="Zz (Plastic)" value={calculatedProps["Plastic Mod. Zz (Syy)"]} />
                                                    <PropRow label="ry (Gyration)" value={calculatedProps["Radius Gyration ry"]} color="text-slate-400" />
                                                    <PropRow label="rz (Gyration)" value={calculatedProps["Radius Gyration rz"]} color="text-slate-400" />
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}

                        {/* --- CONFIGURA√á√ÉO DE CASCAS (SHELLS) --- */}
                        {isShell && (
                            <div className="space-y-6">
                                {/* Physical Properties */}
                                <div>
                                    <div className="flex items-center gap-2 mb-3">
                                        <span className="text-[10px] font-bold text-blue-400 uppercase tracking-widest">Physical Properties</span>
                                        <div className="h-px bg-slate-800 flex-1"></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="relative group">
                                            <div className="absolute inset-y-0 left-0 w-24 rounded-l border-y border-l bg-slate-800 border-slate-700 text-slate-400 flex items-center justify-center text-[9px] font-bold pointer-events-none uppercase">
                                                Thickness
                                            </div>
                                            <input type="text" className="w-full bg-slate-900 border border-slate-700 focus:border-blue-500 text-white text-sm rounded pl-28 pr-2 py-1.5 outline-none font-mono transition-all"
                                                value={selected.section_params?.thickness || 0}
                                                onChange={(e) => handleParamEdit(selectedIdx, 'thickness', e.target.value)}
                                            />
                                        </div>
                                        <div className="relative group">
                                            <div className="absolute inset-y-0 left-0 w-24 rounded-l border-y border-l bg-purple-900/30 border-purple-800 text-purple-400 flex items-center justify-center text-[9px] font-bold pointer-events-none uppercase">
                                                Eccentricity
                                            </div>
                                            <input type="text" className="w-full bg-slate-900 border border-purple-800 focus:border-purple-500 text-white text-sm rounded pl-28 pr-2 py-1.5 outline-none font-mono transition-all"
                                                value={selected.section_params?.offset || 0}
                                                onChange={(e) => handleParamEdit(selectedIdx, 'offset', e.target.value)}
                                            />
                                        </div>
                                    </div>
                                </div>

                                {/* Reference Vector */}
                                <div>
                                    <div className="flex items-center gap-2 mb-3">
                                        <span className="text-[10px] font-bold text-orange-400 uppercase tracking-widest">Reference Orientation (Local X)</span>
                                        <div className="h-px bg-slate-800 flex-1"></div>
                                    </div>
                                    
                                    <div className="p-3 bg-slate-900/50 rounded border border-slate-800 mb-3">
                                        <div className="flex items-center gap-2 mb-2 text-slate-500 text-[9px]">
                                            <span className="text-xl">‚Ü≥</span>
                                            <p className="leading-tight">
                                                Vector projected onto the surface to define the element's <strong className="text-slate-300">Local X Axis</strong>.
                                                <br/>Typical: <strong>(1, 0, 0)</strong> for Floors, <strong>(0, 1, 0)</strong> for Walls.
                                            </p>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-3 gap-3">
                                        {['vx', 'vy', 'vz'].map((axis, i) => (
                                            <div key={axis} className="relative group">
                                                <div className="absolute inset-y-0 left-0 w-10 rounded-l border-y border-l bg-orange-900/20 border-orange-800/50 text-orange-400 flex items-center justify-center text-[9px] font-bold pointer-events-none uppercase">
                                                    {axis.toUpperCase()}
                                                </div>
                                                <input type="text" className="w-full bg-slate-900 border border-orange-800/50 focus:border-orange-500 text-white text-sm rounded pl-12 pr-2 py-1.5 outline-none font-mono transition-all text-center"
                                                    value={selected.section_params?.[axis] || 0}
                                                    onChange={(e) => handleParamEdit(selectedIdx, axis, e.target.value)}
                                                />
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
                
                {/* RESIZER */}
                <div className="w-1 bg-slate-950 hover:bg-blue-600 cursor-col-resize flex items-center justify-center z-20 border-l border-slate-800 shadow-xl" onMouseDown={handleMouseDown}><div className="h-8 w-0.5 bg-slate-700 rounded-full pointer-events-none"></div></div>

                {/* PREVIEW */}
                <div className="flex-1 flex flex-col bg-white relative min-w-[200px]">
                    <div className="h-12 border-b border-slate-200 flex items-center justify-between px-4 bg-slate-50 shrink-0">
                        <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Section Preview</span>
                    </div>
                    <div className="flex-1 relative overflow-hidden bg-white flex items-center justify-center">
                         {isBeam ? (
                             <SectionVisualizer imageSrc={sectionImage} loading={calcLoading} error={calcError} />
                         ) : (
                             <div className="text-center text-slate-300 select-none">
                                <span className="text-6xl mb-4 block opacity-20">‚¨°</span>
                                <span className="text-xs font-bold uppercase tracking-widest">3D Shell Element</span>
                                <p className="text-[10px] mt-2 max-w-[200px] mx-auto opacity-60">Visualized in the main 3D Viewport</p>
                             </div>
                         )}
                    </div>
                </div>
            </div>
        </div>
    );
};

// Helper Component for Property Rows with Enhanced Formatting
const PropRow = ({ label, value, highlight, color }) => {
    // Formata o n√∫mero de forma inteligente
    const formatVal = (v) => {
        if (v === undefined || v === null) return '-';
        if (typeof v !== 'number') return v;
        // Zero efetivo
        if (Math.abs(v) < 1e-9) return '0.00';
        // Nota√ß√£o cient√≠fica para n√∫meros muito pequenos ou muito grandes
        if (Math.abs(v) < 1e-3 || Math.abs(v) > 1e5) return v.toExponential(3);
        // Decimal padr√£o para dimens√µes normais
        return v.toFixed(2);
    };

    return (
        <div className={`flex justify-between items-center px-2 py-1.5 rounded border transition-colors ${highlight ? 'bg-purple-900/20 border-purple-500/30' : 'bg-slate-950/50 border-slate-800'}`}>
            <span className={`text-[9px] font-medium truncate mr-2 ${highlight ? 'text-purple-300' : 'text-slate-500'}`}>{label}</span>
            <span className={`text-[10px] font-mono ${highlight ? 'text-white font-bold' : (color || 'text-blue-300')}`}>
                {formatVal(value)}
            </span>
        </div>
    );
};

window.GeometryConfig = GeometryConfig;

--- ARQUIVO: prosolve\LoadCaseConfig.js ---
// =========================================================
// ARQUIVO: LoadCaseConfig.js
// PATH: prosolve/LoadCaseConfig.js
// =========================================================

const React = window.React || require('react');
const { useState, useEffect } = React;

const LoadCaseConfig = () => {
    const [loadCases, setLoadCases] = useState([]);
    const [availRestrictions, setAvailRestrictions] = useState([]);
    const [availLoads, setAvailLoads] = useState([]);

    // --- 1. CARREGAR DADOS GLOBAIS ---
    useEffect(() => {
        // Carrega o que foi definido nas abas anteriores
        const r = window.projectState?.restrictions || [];
        const l = window.projectState?.loads || [];
        
        setAvailRestrictions(r);
        setAvailLoads(l);

        // Carrega casos salvos ou inicia vazio
        const savedCases = window.projectState?.load_cases || [];
        setLoadCases(savedCases);
    }, []);

    // --- 2. SYNC GLOBAL ---
    useEffect(() => {
        if (window.projectState) {
            window.projectState.load_cases = loadCases;
        }
    }, [loadCases]);

    // --- HANDLERS ---

    const handleAddCase = () => {
        const id = Date.now();
        const num = loadCases.length + 1;
        const newCase = {
            id: id,
            name: `Case_${num}`,
            restrictions: [], // Array de nomes (strings)
            loads: []         // Array de nomes (strings)
        };
        setLoadCases([...loadCases, newCase]);
    };

    const handleDelete = (id) => {
        if (confirm("Delete this Load Case?")) {
            setLoadCases(prev => prev.filter(lc => lc.id !== id));
        }
    };

    const handleNameChange = (id, val) => {
        setLoadCases(prev => prev.map(lc => lc.id === id ? { ...lc, name: val } : lc));
    };

    // Toggle Gen√©rico: Adiciona ou remove o NOME da lista
    const toggleItem = (caseId, listType, itemName) => {
        setLoadCases(prev => prev.map(lc => {
            if (lc.id !== caseId) return lc;

            const currentList = lc[listType] || [];
            const exists = currentList.includes(itemName);

            let newList;
            if (exists) {
                newList = currentList.filter(n => n !== itemName);
            } else {
                newList = [...currentList, itemName];
            }

            return { ...lc, [listType]: newList };
        }));
    };

    // --- RENDER ---

    return (
        <div className="flex flex-col h-full w-full bg-slate-950 text-slate-200 text-sm font-sans border-t border-slate-900">
            
            {/* HEADER */}
            <div className="h-14 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900 shrink-0">
                <div className="flex items-center gap-3">
                    <div className="w-8 h-8 flex items-center justify-center bg-slate-800 rounded border border-slate-700 text-xl">üìö</div>
                    <div>
                        <h2 className="text-sm font-bold text-white leading-none">Load Cases</h2>
                        <span className="text-[9px] text-slate-500 font-mono uppercase tracking-wider">Analysis Scenarios (MECA_STATIQUE)</span>
                    </div>
                </div>
                <button onClick={handleAddCase} className="bg-blue-600 hover:bg-blue-500 text-white px-4 py-1.5 rounded text-xs font-bold transition-all shadow-lg active:scale-95 flex items-center gap-2">
                    <span>+</span> New Case
                </button>
            </div>

            {/* TABELA DE CASOS */}
            <div className="flex-1 overflow-y-auto p-6 custom-scrollbar bg-slate-900">
                
                {loadCases.length === 0 ? (
                    <div className="flex flex-col items-center justify-center h-64 text-slate-600 opacity-60 border-2 border-dashed border-slate-800 rounded-xl">
                        <span className="text-4xl mb-2">üì≠</span>
                        <p className="text-xs">No Load Cases defined.</p>
                        <p className="text-[10px] mt-1">Combine restrictions and loads here.</p>
                    </div>
                ) : (
                    <div className="space-y-4 max-w-6xl mx-auto">
                        
                        {/* CABE√áALHOS VISUAIS DAS COLUNAS (Estilo Tabela do seu desenho) */}
                        <div className="flex gap-4 px-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">
                            <div className="w-40">Case Name</div>
                            <div className="flex-1 border-l border-slate-800 pl-4">Active Restrictions (Boundary Conditions)</div>
                            <div className="flex-1 border-l border-slate-800 pl-4">Active Loads</div>
                            <div className="w-8"></div>
                        </div>

                        {loadCases.map((lc) => (
                            <div key={lc.id} className="flex gap-4 bg-slate-950 border border-slate-800 rounded-lg p-3 hover:border-slate-700 transition-all items-stretch shadow-md">
                                
                                {/* 1. NOME DO CASO */}
                                <div className="w-40 flex flex-col justify-center shrink-0">
                                    <input 
                                        type="text" 
                                        className="w-full bg-slate-900 border border-slate-700 rounded px-2 py-1.5 text-xs font-bold text-white focus:border-blue-500 outline-none"
                                        value={lc.name}
                                        onChange={(e) => handleNameChange(lc.id, e.target.value)}
                                        placeholder="Case Name"
                                    />
                                </div>

                                {/* 2. COLUNA RESTRI√á√ïES */}
                                <div className="flex-1 border-l border-slate-800 pl-4 flex flex-col justify-center">
                                    {availRestrictions.length === 0 && <span className="text-[9px] text-slate-600 italic">No restrictions available</span>}
                                    <div className="flex flex-wrap gap-2">
                                        {availRestrictions.map(r => {
                                            const isActive = lc.restrictions.includes(r.name);
                                            return (
                                                <button 
                                                    key={r.id}
                                                    onClick={() => toggleItem(lc.id, 'restrictions', r.name)}
                                                    className={`
                                                        px-2 py-1 rounded border text-[10px] font-bold transition-all flex items-center gap-1
                                                        ${isActive 
                                                            ? 'bg-blue-600 border-blue-500 text-white shadow-sm' 
                                                            : 'bg-slate-900 border-slate-700 text-slate-500 hover:border-slate-500 hover:text-slate-300'}
                                                    `}
                                                    title={`Group: ${r.group}`}
                                                >
                                                    <span className="opacity-70 text-[8px]">üìç</span>
                                                    {r.name}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* 3. COLUNA CARGAS */}
                                <div className="flex-1 border-l border-slate-800 pl-4 flex flex-col justify-center">
                                    {availLoads.length === 0 && <span className="text-[9px] text-slate-600 italic">No loads available</span>}
                                    <div className="flex flex-wrap gap-2">
                                        {availLoads.map(l => {
                                            const isActive = lc.loads.includes(l.name);
                                            // Cor diferente para Cargas (Roxo/Laranja)
                                            return (
                                                <button 
                                                    key={l.id}
                                                    onClick={() => toggleItem(lc.id, 'loads', l.name)}
                                                    className={`
                                                        px-2 py-1 rounded border text-[10px] font-bold transition-all flex items-center gap-1
                                                        ${isActive 
                                                            ? 'bg-purple-600 border-purple-500 text-white shadow-sm' 
                                                            : 'bg-slate-900 border-slate-700 text-slate-500 hover:border-slate-500 hover:text-slate-300'}
                                                    `}
                                                    title={`Group: ${l.group}`}
                                                >
                                                    <span className="opacity-70 text-[8px]">{l.type === 'PESANTEUR' ? 'üçé' : '‚ö°'}</span>
                                                    {l.name}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>

                                {/* 4. DELETE */}
                                <div className="w-8 flex items-center justify-center border-l border-slate-800 pl-2">
                                    <button 
                                        onClick={() => handleDelete(lc.id)}
                                        className="w-6 h-6 flex items-center justify-center text-slate-600 hover:text-red-400 hover:bg-red-500/10 rounded transition-colors"
                                        title="Delete Case"
                                    >
                                        ‚úï
                                    </button>
                                </div>

                            </div>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
};

window.LoadCaseConfig = LoadCaseConfig;

--- ARQUIVO: prosolve\LoadConfig.js ---
// =========================================================
// ARQUIVO: LoadConfig.js
// PATH: prosolve/LoadConfig.js
// =========================================================

const React = window.React || require('react');
const { useState, useEffect } = React;

const LoadConfig = () => {
    const [loads, setLoads] = useState([]);
    const [availableGroups, setAvailableGroups] = useState([]);
    const [selectedGroup, setSelectedGroup] = useState(null);

    // --- REGRAS DE NEG√ìCIO (Code_Aster) ---
    // Define quais cargas est√£o dispon√≠veis para cada categoria
    const LOAD_TYPES = {
        'Node': [
            { code: 'FORCE_NODALE', label: 'Nodal Force', icon: 'üéØ', fields: ['FX', 'FY', 'FZ', 'MX', 'MY', 'MZ'] }
        ],
        '1D': [
            { code: 'FORCE_POUTRE', label: 'Beam Force (Dist.)', icon: 'üìè', fields: ['FX', 'FY', 'FZ'] },
            { code: 'PESANTEUR', label: 'Gravity', icon: 'üçé', fields: ['GRAV', 'DX', 'DY', 'DZ'] }
        ],
        '2D': [
            { code: 'PRES_REP', label: 'Pressure (Normal)', icon: '‚¨áÔ∏è', fields: ['PRES'] },
            { code: 'FORCE_COQUE', label: 'Shell Force (Vector)', icon: 'üí®', fields: ['FX', 'FY', 'FZ'] },
            { code: 'PESANTEUR', label: 'Gravity', icon: 'üçé', fields: ['GRAV', 'DX', 'DY', 'DZ'] }
        ]
    };

    // --- 1. CARREGAR E FILTRAR DADOS ---
    useEffect(() => {
        const loadRawData = async () => {
            let rawGroups = {};
            
            // Usa a fonte da verdade global
            if (window.projectState?.meshAnalysis) {
                rawGroups = window.projectState.meshAnalysis;
            } else {
                try {
                    const resp = await fetch('http://localhost:5000/api/read_mesh_groups', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folder_path: window.projectState?.projectPath })
                    });
                    const json = await resp.json();
                    if (json.status === 'success') rawGroups = json.data.groups;
                } catch (e) { console.error("LoadConfig load error", e); }
            }

            const processedGroups = Object.entries(rawGroups)
                .map(([name, info]) => ({
                    name: name,
                    type: Object.keys(info.types).join(', '),
                    category: window.classifyMeshGroup ? window.classifyMeshGroup(info.types) : '3D'
                }))
                // FILTRO: Loads aplicados em N√≥s, 1D e 2D. 3D filtrado conforme pedido.
                .filter(g => g.category !== '3D' && g.category !== 'Point'); // Point geralmente √© geometry helper

            setAvailableGroups(processedGroups);

            const savedLoads = window.projectState?.loads || [];
            setLoads(savedLoads);

            if (!selectedGroup && processedGroups.length > 0) {
                setSelectedGroup(processedGroups[0].name);
            }
        };

        loadRawData();
    }, []);

    // --- 2. SYNC GLOBAL ---
    useEffect(() => {
        if (window.projectState) {
            window.projectState.loads = loads;
        }
    }, [loads]);

    // --- HELPERS ---
    const generateUniqueName = (baseName, excludeId = null) => {
        let candidate = baseName;
        let counter = 1;
        const nameExists = (name) => loads.some(l => l.name === name && l.id !== excludeId);
        if (baseName.trim() === '' || nameExists(candidate)) {
            const cleanBase = baseName.replace(/_\d+$/, ''); 
            candidate = `${cleanBase}_${counter}`;
            while (nameExists(candidate)) {
                counter++;
                candidate = `${cleanBase}_${counter}`;
            }
        }
        return candidate;
    };

    // --- HANDLERS ---
    const handleAddLoad = () => {
        if (!selectedGroup) return;
        const groupInfo = availableGroups.find(g => g.name === selectedGroup);
        if (!groupInfo) return;

        // Pega o primeiro tipo dispon√≠vel como default
        const availableTypes = LOAD_TYPES[groupInfo.category] || LOAD_TYPES['1D'];
        const defaultType = availableTypes[0];

        const newLoad = {
            id: Date.now(),
            name: generateUniqueName(`Load_${selectedGroup}`),
            type: defaultType.code,
            group: selectedGroup,
            params: {}
        };
        
        // Se for Gravidade, preenche defaults
        if (defaultType.code === 'PESANTEUR') {
            newLoad.params = { GRAV: 9.81, DX: 0, DY: 0, DZ: -1 };
        }

        setLoads([...loads, newLoad]);
    };

    const handleCopyLoad = (original) => {
        const newName = generateUniqueName(`${original.name}_copy`);
        const copy = { ...original, id: Date.now(), name: newName, params: { ...original.params } };
        setLoads([...loads, copy]);
    };

    const handleDelete = (id) => setLoads(prev => prev.filter(l => l.id !== id));
    
    const handleUpdate = (id, field, value) => {
        setLoads(prev => prev.map(l => {
            if (l.id !== id) return l;
            
            // Se mudar o tipo, reseta params (exceto se for mudar para gravidade, ai preenche defaults)
            if (field === 'type') {
                let newParams = {};
                if (value === 'PESANTEUR') newParams = { GRAV: 9.81, DX: 0, DY: 0, DZ: -1 };
                return { ...l, type: value, params: newParams };
            }
            
            return { ...l, [field]: value };
        }));
    };

    const handleNameBlur = (id, currentName) => {
        const isDuplicate = loads.some(l => l.name === currentName && l.id !== id);
        const isEmpty = currentName.trim() === '';
        if (isDuplicate || isEmpty) {
            const safeName = generateUniqueName(isEmpty ? `Load_Case` : currentName, id);
            setLoads(prev => prev.map(l => l.id === id ? { ...l, name: safeName } : l));
        }
    };

    const updateParam = (id, paramKey, value) => {
        setLoads(prev => prev.map(l => {
            if (l.id !== id) return l;
            const newParams = { ...l.params };
            if (value === '' || value === null) delete newParams[paramKey];
            else newParams[paramKey] = value;
            return { ...l, params: newParams };
        }));
    };

    // --- RENDER HELPERS ---
    const getGroupIcon = (cat) => {
        if (cat === '2D') return '‚¨õ';
        if (cat === '1D') return 'üìè';
        return 'üìç';
    };

    const activeGroupInfo = availableGroups.find(g => g.name === selectedGroup);
    const currentGroupLoads = loads.filter(l => l.group === selectedGroup);
    
    // Op√ß√µes de tipos para o grupo atual
    const allowedTypes = activeGroupInfo ? (LOAD_TYPES[activeGroupInfo.category] || []) : [];

    return (
        <div className="flex h-full w-full bg-slate-950 text-slate-200 text-sm overflow-hidden font-sans">
            
            {/* SIDEBAR (Lista de Grupos) */}
            <div className="w-60 border-r border-slate-800 bg-slate-950 flex flex-col shrink-0">
                <div className="h-10 border-b border-slate-800 flex items-center px-4 bg-slate-950/50">
                    <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Target Groups</span>
                </div>
                
                <div className="flex-1 overflow-y-auto custom-scrollbar p-1 space-y-0.5">
                    {availableGroups.map((grp) => {
                        const count = loads.filter(l => l.group === grp.name).length;
                        const isSelected = selectedGroup === grp.name;
                        return (
                            <div key={grp.name} onClick={() => setSelectedGroup(grp.name)} className={`flex justify-between items-center px-3 py-2.5 rounded cursor-pointer border-l-2 transition-all ${isSelected ? 'bg-slate-900 border-blue-500 text-white' : 'bg-transparent border-transparent hover:bg-slate-900/50 text-slate-400'}`}>
                                <div className="flex items-center gap-2 overflow-hidden">
                                    <span className="opacity-70 text-xs">{getGroupIcon(grp.category)}</span>
                                    <span className={`text-xs truncate ${isSelected ? 'font-bold' : 'font-medium'}`}>{grp.name}</span>
                                </div>
                                {count > 0 && <span className="text-[9px] font-bold px-1.5 py-0.5 bg-blue-900/30 text-blue-400 rounded-full">{count}</span>}
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* √ÅREA PRINCIPAL */}
            <div className="flex-1 flex flex-col bg-slate-900">
                {activeGroupInfo ? (
                    <>
                        {/* HEADER */}
                        <div className="h-14 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900 shrink-0">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 flex items-center justify-center bg-slate-800 rounded border border-slate-700">{getGroupIcon(activeGroupInfo.category)}</div>
                                <div>
                                    <h2 className="text-sm font-bold text-white leading-none">{activeGroupInfo.name}</h2>
                                    <div className="flex items-center gap-2 mt-0.5"><span className="text-[9px] text-blue-400 font-mono font-bold uppercase tracking-wider">{activeGroupInfo.category} Loads</span></div>
                                </div>
                            </div>
                            <button onClick={handleAddLoad} className="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-xs font-bold transition-all shadow-lg active:scale-95 flex items-center gap-2"><span>+</span> Add Load</button>
                        </div>

                        {/* LISTA */}
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-900">
                            {currentGroupLoads.length === 0 ? (
                                <div className="h-40 flex flex-col items-center justify-center text-slate-600 opacity-60 border-2 border-dashed border-slate-800 rounded-lg m-4">
                                    <span className="text-2xl mb-2">üèãÔ∏è</span>
                                    <p className="text-xs">No loads applied to this group.</p>
                                </div>
                            ) : (
                                <div className="space-y-2 w-full">
                                    {currentGroupLoads.map((load) => {
                                        const loadDef = allowedTypes.find(t => t.code === load.type) || allowedTypes[0];
                                        const fields = loadDef.fields;
                                        const isDuplicate = loads.some(l => l.name === load.name && l.id !== load.id);

                                        return (
                                            <div key={load.id} className="bg-slate-950 border border-slate-800 rounded px-2 py-1 flex items-center gap-2 hover:border-slate-700 transition-colors shadow-sm group w-full">
                                                
                                                {/* 1. Nome da Carga */}
                                                <div className="w-32 shrink-0 relative">
                                                    <input 
                                                        type="text" 
                                                        className={`w-full bg-slate-900/50 border-b text-xs font-bold text-slate-200 outline-none px-1 py-1 transition-all ${isDuplicate ? 'border-red-500/80 text-red-200' : 'border-transparent hover:border-slate-600 focus:border-blue-500'}`}
                                                        value={load.name} onChange={(e) => handleUpdate(load.id, 'name', e.target.value)} onBlur={(e) => handleNameBlur(load.id, e.target.value)}
                                                        placeholder="Load Name" title="Must be unique" />
                                                    {isDuplicate && <span className="absolute right-0 top-1 text-[8px] text-red-500 font-bold animate-pulse">!</span>}
                                                </div>

                                                {/* 2. Seletor de Tipo (Importante pois aqui pode variar) */}
                                                <div className="w-24 shrink-0">
                                                    <select 
                                                        className="w-full bg-slate-900 border border-slate-700 text-[10px] font-bold text-slate-300 rounded py-1 px-1 outline-none focus:border-blue-500"
                                                        value={load.type}
                                                        onChange={(e) => handleUpdate(load.id, 'type', e.target.value)}
                                                    >
                                                        {allowedTypes.map(t => <option key={t.code} value={t.code}>{t.icon} {t.label}</option>)}
                                                    </select>
                                                </div>

                                                {/* 3. Divisor */}
                                                <div className="w-px h-6 bg-slate-800"></div>

                                                {/* 4. Grid de Campos (Slim) */}
                                                <div className="flex-1 flex items-center gap-1 overflow-x-auto custom-scrollbar pb-1">
                                                    {fields.map(field => {
                                                        const val = load.params[field];
                                                        const isDefined = val !== undefined && val !== null;
                                                        // Destaque visual para GRAVITE ou PRESSAO
                                                        const isMain = field === 'GRAV' || field === 'PRES';

                                                        return (
                                                            <div key={field} className={`flex items-center gap-1 px-1.5 py-1 rounded border min-w-[55px] transition-all ${isDefined ? (isMain ? 'bg-purple-900/20 border-purple-500/30' : 'bg-blue-900/10 border-blue-500/30') : 'bg-slate-900 border-slate-800 opacity-60'}`}>
                                                                <span className={`text-[9px] font-bold uppercase w-5 text-left ${isMain ? 'text-purple-400' : 'text-slate-500'}`}>{field}</span>
                                                                <input type="text" className="w-12 bg-transparent text-right text-[10px] font-mono text-white outline-none border-b border-blue-500/30 focus:border-blue-400 p-0 placeholder-slate-700"
                                                                    value={val || ''} placeholder="-" onChange={(e) => updateParam(load.id, field, e.target.value)} />
                                                            </div>
                                                        );
                                                    })}
                                                </div>

                                                {/* 5. A√ß√µes */}
                                                <div className="flex items-center gap-1 border-l border-slate-800 pl-2">
                                                    <button onClick={() => handleCopyLoad(load)} className="w-5 h-5 flex items-center justify-center text-slate-500 hover:text-blue-400 hover:bg-blue-500/10 rounded transition-colors" title="Duplicate">‚ùê</button>
                                                    <button onClick={() => handleDelete(load.id)} className="w-5 h-5 flex items-center justify-center text-slate-600 hover:text-red-400 hover:bg-red-500/10 rounded transition-colors" title="Delete">‚úï</button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </>
                ) : (
                    <div className="flex flex-col items-center justify-center h-full text-slate-500 bg-slate-900"><p className="text-sm">Select a group to apply loads</p></div>
                )}
            </div>
        </div>
    );
};

window.LoadConfig = LoadConfig;

--- ARQUIVO: prosolve\MaterialConfig.js ---
const { useState, useEffect, useCallback } = React;

function MaterialConfig() {
    const [assignments, setAssignments] = useState([]);
    const [loading, setLoading] = useState(false);
    
    // Biblioteca de Materiais Pr√©-definidos
    const MATERIAL_LIBRARY = {
        'Steel': {
            E: 210000000000.0, // 210 GPa
            NU: 0.3,
            RHO: 7850.0,
            ALPHA: 1.2e-5
        },
        'Aluminium': {
            E: 70000000000.0, // 70 GPa
            NU: 0.33,
            RHO: 2700.0,
            ALPHA: 2.3e-5
        },
        'Concrete': {
            E: 30000000000.0, // 30 GPa
            NU: 0.2,
            RHO: 2400.0,
            ALPHA: 1.0e-5
        },
        'Titanium': {
            E: 116000000000.0,
            NU: 0.32,
            RHO: 4500.0,
            ALPHA: 0.86e-5
        },
        'Glass': {
            E: 70000000000.0,
            NU: 0.22,
            RHO: 2500.0,
            ALPHA: 0.9e-5
        }
    };

    // Pega os grupos da aba anterior (Model)
    const projectPath = window.projectState?.projectPath;
    const geometryGroups = window.projectState?.geometries || [];

    // --- INICIALIZA√á√ÉO ---
    useEffect(() => {
        if (projectPath) {
            initializeMaterials();
        }
    }, [projectPath, geometryGroups]);

    const initializeMaterials = () => {
        setLoading(true);
        
        // 1. Recupera atribui√ß√µes salvas (Quem usa o qu√™ + PROPRIEDADES salvas)
        const savedAssignments = window.projectState?.material_assignments || [];
        
        let initialData = [];

        if (geometryGroups.length > 0) {
            initialData = geometryGroups
                .filter(geo => geo._category !== 'Node' && geo._category !== 'Point') // <--- FILTRO NOVO
                .map(geo => {
                const existing = savedAssignments.find(m => m.group === geo.group);
                
                if (existing) {
                    const matName = existing.material || 'Steel';
                    
                    // L√≥gica de Persist√™ncia Robusta:
                    // Se existirem propriedades salvas no objeto de atribui√ß√£o, usa elas.
                    // Se n√£o (primeira vez ou legado), pega da biblioteca.
                    const recoveredProps = existing.props ? { ...existing.props } : 
                                           (MATERIAL_LIBRARY[matName] ? { ...MATERIAL_LIBRARY[matName] } : { ...MATERIAL_LIBRARY['Steel'] });

                    return { 
                        group: geo.group,
                        materialName: matName,
                        props: recoveredProps, 
                        selected: true 
                    };
                } else {
                    // Novo grupo (ainda n√£o configurado): Padr√£o Steel
                    return {
                        group: geo.group,
                        materialName: 'Steel',
                        props: { ...MATERIAL_LIBRARY['Steel'] },
                        selected: true
                    };
                }
            });
        }
        
        setAssignments(initialData);
        setLoading(false);
    };   

    // --- SYNC COM ESTADO GLOBAL ---
    // Atualiza o projectState sempre que houver mudan√ßas
    useEffect(() => {
        if (assignments.length > 0) {
            // 1. Lista de Atribui√ß√µes (Salva PROPS aqui para garantir persist√™ncia exata por grupo)
            const exportAssignments = assignments
                .filter(a => a.selected)
                .map(a => ({
                    group: a.group,
                    material: a.materialName,
                    props: a.props // Salva os valores editados
                }));

            // 2. Lista de Defini√ß√µes √önicas (Para o gerador .comm do Code_Aster)
            const uniqueMaterials = [];
            
            assignments.filter(a => a.selected).forEach(a => {
                const existingIndex = uniqueMaterials.findIndex(m => m.name === a.materialName);
                
                // Converte props para n√∫meros reais antes de enviar para o Aster (limpa strings tempor√°rias)
                const cleanProps = {};
                Object.keys(a.props).forEach(k => {
                    const val = parseFloat(a.props[k]);
                    cleanProps[k] = isNaN(val) ? 0.0 : val;
                });

                if (existingIndex === -1) {
                    uniqueMaterials.push({
                        name: a.materialName,
                        props: cleanProps
                    });
                } else {
                    // Se j√° existe, mantemos o primeiro. 
                    // (Em uma vers√£o futura, poder√≠amos criar materiais Steel_1, Steel_2 se as props forem diferentes)
                    uniqueMaterials[existingIndex].props = cleanProps;
                }
            });

            // Atualiza estado global
            window.projectState.materials = uniqueMaterials;
            window.projectState.material_assignments = exportAssignments; 
        }
    }, [assignments]);

    // --- HANDLERS ---

    const handleMaterialSelect = (index, matName) => {
        const newAssignments = [...assignments];
        newAssignments[index].materialName = matName;
        // Carrega as propriedades do preset se dispon√≠vel
        if (matName !== 'Custom' && MATERIAL_LIBRARY[matName]) {
             newAssignments[index].props = { ...MATERIAL_LIBRARY[matName] };
        }
        setAssignments(newAssignments);
    };

    const handlePropChange = (index, propKey, rawValue) => {
        const newAssignments = [...assignments];
        
        // 1. Permite limpar o campo (string vazia)
        if (rawValue === '') {
            newAssignments[index].props[propKey] = '';
            setAssignments(newAssignments);
            return;
        }

        // 2. Troca v√≠rgula por ponto (compatibilidade PT-BR)
        let cleanValue = rawValue.replace(',', '.');

        // 3. Valida√ß√£o: S√≥ aceita se for num√©rico ou parte v√°lida de um n√∫mero em constru√ß√£o
        // Permite: "0", "0.", "-5", "1e", "1e-"
        if (!isNaN(cleanValue) || cleanValue === '-' || cleanValue.endsWith('.') || cleanValue.toLowerCase().endsWith('e') || cleanValue.toLowerCase().endsWith('e-')) {
            newAssignments[index].props[propKey] = cleanValue;
            setAssignments(newAssignments);
        }
    };

    const applyToAll = (sourceIndex) => {
        const sourceMat = assignments[sourceIndex];
        const newAssignments = assignments.map(a => ({
            ...a,
            materialName: sourceMat.materialName,
            props: { ...sourceMat.props }
        }));
        setAssignments(newAssignments);
    };

    // --- RENDER ---

    if (loading) return <div className="text-center p-10 text-blue-400">Loading Materials...</div>;

    if (assignments.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center h-full p-10 text-slate-400">
                <div className="text-4xl mb-4 text-slate-600">üß™</div>
                <h3 className="text-xl font-bold text-slate-300 mb-2">No Groups Defined</h3>
                <p className="text-sm text-center mb-4">Please go to the <strong>Model</strong> tab and define your element groups first.</p>
            </div>
        );
    }

    return (
        <div className="flex flex-col h-full w-full max-w-[95%] mx-auto animate-in fade-in duration-500 p-2">
            
            {/* Header */}
            <div className="flex justify-between items-center mb-4 bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                <div className="text-xs text-slate-400 font-medium">
                    <span className="text-blue-400 font-bold">Tip:</span> Use <strong>DOTS (.)</strong> for decimals. Values in SI Units (Pa, kg/m¬≥, K‚Åª¬π).
                </div>
                <div className="text-[10px] text-slate-500 uppercase font-bold tracking-wider">
                    Material Definition (DEFI_MATERIAU)
                </div>
            </div>

            {/* Table */}
            <div className="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden shadow-xl flex-1 flex flex-col">
                <div className="overflow-y-auto flex-1 custom-scrollbar">
                    <table className="w-full text-left border-collapse">
                        <thead className="bg-slate-950 text-slate-400 text-[10px] uppercase tracking-wider sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th className="p-3 border-b border-slate-800 w-48">Group Name</th>
                                <th className="p-3 border-b border-slate-800 w-40">Material Preset</th>
                                <th className="p-3 border-b border-slate-800 text-center w-32" title="Young's Modulus (Pa)">E (Pa)</th>
                                <th className="p-3 border-b border-slate-800 text-center w-24" title="Poisson Ratio">NU</th>
                                <th className="p-3 border-b border-slate-800 text-center w-28" title="Density (kg/m¬≥)">RHO (kg/m¬≥)</th>
                                <th className="p-3 border-b border-slate-800 text-center w-28" title="Thermal Expansion">ALPHA (K‚Åª¬π)</th>
                                <th className="p-3 border-b border-slate-800 w-10"></th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700/50 text-sm">
                            {assignments.map((item, idx) => (
                                <tr key={idx} className="transition-colors hover:bg-slate-700/30">
                                    
                                    {/* Group Name (Read Only) */}
                                    <td className="p-3 font-mono font-medium text-slate-300 truncate max-w-[200px]" title={item.group}>
                                        {item.group}
                                    </td>

                                    {/* Material Selector */}
                                    <td className="p-3">
                                        <select 
                                            value={item.materialName} 
                                            onChange={(e) => handleMaterialSelect(idx, e.target.value)}
                                            className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1.5 text-blue-300 text-xs focus:ring-1 focus:ring-blue-500 outline-none font-bold"
                                        >
                                            {Object.keys(MATERIAL_LIBRARY).map(mat => (
                                                <option key={mat} value={mat}>{mat}</option>
                                            ))}
                                            <option value="Custom">Custom</option>
                                        </select>
                                    </td>

                                    {/* Properties Inputs - Type TEXT to allow free typing */}
                                    <td className="p-2">
                                        <input 
                                            type="text" 
                                            value={item.props.E}
                                            onChange={(e) => handlePropChange(idx, 'E', e.target.value)}
                                            className="w-full bg-slate-900/50 border border-slate-600/50 rounded px-2 py-1 text-slate-200 text-xs text-right focus:border-blue-500 outline-none font-mono"
                                        />
                                    </td>
                                    <td className="p-2">
                                        <input 
                                            type="text" 
                                            value={item.props.NU}
                                            onChange={(e) => handlePropChange(idx, 'NU', e.target.value)}
                                            className="w-full bg-slate-900/50 border border-slate-600/50 rounded px-2 py-1 text-slate-200 text-xs text-right focus:border-blue-500 outline-none font-mono"
                                        />
                                    </td>
                                    <td className="p-2">
                                        <input 
                                            type="text" 
                                            value={item.props.RHO}
                                            onChange={(e) => handlePropChange(idx, 'RHO', e.target.value)}
                                            className="w-full bg-slate-900/50 border border-slate-600/50 rounded px-2 py-1 text-slate-200 text-xs text-right focus:border-blue-500 outline-none font-mono"
                                        />
                                    </td>
                                    <td className="p-2">
                                        <input 
                                            type="text" 
                                            value={item.props.ALPHA}
                                            onChange={(e) => handlePropChange(idx, 'ALPHA', e.target.value)}
                                            className="w-full bg-slate-900/50 border border-slate-600/50 rounded px-2 py-1 text-slate-200 text-xs text-right focus:border-blue-500 outline-none font-mono"
                                        />
                                    </td>

                                    {/* Actions */}
                                    <td className="p-2 text-center">
                                        <button 
                                            onClick={() => applyToAll(idx)}
                                            className="text-[10px] text-slate-500 hover:text-blue-400 underline cursor-pointer"
                                            title="Apply this material to all groups"
                                        >
                                            All
                                        </button>
                                    </td>

                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
}

// Export global
window.MaterialConfig = MaterialConfig;

--- ARQUIVO: prosolve\ModelConfig.js ---
const { useState, useEffect } = React;

function ModelConfig() {
    const [groups, setGroups] = useState([]);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);

    // Op√ß√µes baseadas no PDF do Code_Aster
    const MODEL_OPTIONS = {
        '1D': [
            { value: 'POU_D_T', label: 'Beam (Timoshenko) - POU_D_T' },
            { value: 'POU_D_E', label: 'Beam (Euler) - POU_D_E' },
            { value: 'BARRE', label: 'Truss/Bar - BARRE' },
            { value: 'CABLE', label: 'Cable - CABLE' }
        ],
        '2D': [
            { value: 'DKT', label: 'Plate (Thin) - DKT' },
            { value: 'DST', label: 'Plate (Thick) - DST' },
            { value: 'COQUE_3D', label: 'Shell 3D - COQUE_3D' },
            { value: 'MEMBRANE', label: 'Membrane - MEMBRANE' },
            { value: 'C_PLAN', label: 'Plane Strain - C_PLAN' },
            { value: 'D_PLAN', label: 'Plane Stress - D_PLAN' },
            { value: 'AXIS', label: 'Axisymmetric - AXIS' }
        ],
        '3D': [
            { value: '3D', label: 'Solid/Volume - 3D' }
        ]
    };

    const projectPath = window.projectState?.projectPath;

    // --- SYNC COM O ESTADO GLOBAL ---
    // Sempre que 'groups' mudar, atualizamos o objeto global que o bot√£o "Save Project" vai ler
    useEffect(() => {
        if (groups.length > 0) {
            // Formata para o padr√£o esperado pelo backend (geometry.json)
            const exportData = groups
                .filter(g => g.selected)
                .map(g => ({
                    group: g.name,
                    type: g.model,
                    formulation: (g.model === 'DKT' || g.model === 'DST') ? g.model : undefined,
                    phenomenon: 'MECANIQUE',
                    // Metadados extras √∫teis para UI futura
                    _category: g.category 
                }));
            
            // Atualiza global
            window.projectState.geometries = exportData;
            console.log("[ModelConfig] Synced to global state:", exportData.length, "items");
        }
    }, [groups]);

    // --- CARREGAMENTO INICIAL ---
    useEffect(() => {
        if (projectPath) {
            loadMeshGroups();
        }
    }, [projectPath]);

    const detectCategory = (typesObj) => {
        const types = Object.keys(typesObj);
        if (types.some(t => t === 'Node')) return 'Node'; 
        if (types.some(t => t.includes('HEXA') || t.includes('TETRA') || t.includes('PENTA'))) return '3D';
        if (types.some(t => t.includes('QUAD') || t.includes('TRIA'))) return '2D';
        if (types.some(t => t.includes('SEG'))) return '1D';
        return '3D';
    };

    const detectDefaultModel = (category) => {
         if (category === 'Node') return 'Node';
        if (category === '3D') return '3D';
        if (category === '2D') return 'DKT';
        if (category === '1D') return 'POU_D_T';
        return '3D';
    };


const loadMeshGroups = async () => {
        setLoading(true);
        setError(null);
        try {
            const response = await fetch('http://localhost:5000/api/read_mesh_groups', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder_path: projectPath })
            });

            const result = await response.json();
            if (result.status === 'error') throw new Error(result.message);

            const data = result.data;

            if(window.projectState) {
                window.projectState.meshAnalysis = data.groups;
            }


            const loadedGroups = [];
            
            // --- L√ìGICA DE PERSIST√äNCIA ---
            // Recupera o que j√° foi salvo anteriormente no estado global
            const savedGeometries = window.projectState?.geometries || [];
            const hasSavedData = savedGeometries.length > 0;

            if (data && data.groups) {
                Object.entries(data.groups).forEach(([groupName, info]) => {
                    const category = detectCategory(info.types);
                    const compStr = Object.entries(info.types)
                        .map(([t, q]) => `${t}:${q}`)
                        .join(', ');

                    // Verifica se este grupo j√° existe no estado salvo
                    const savedGroup = savedGeometries.find(g => g.group === groupName);

                    // Determina se est√° selecionado e qual modelo usar
                    // Se temos dados salvos:
                    //   - Se o grupo est√° no salvo -> Selecionado = true, Modelo = salvo
                    //   - Se o grupo N√ÉO est√° no salvo -> Selecionado = false (usu√°rio desmarcou antes)
                    // Se N√ÉO temos dados salvos (primeira vez) -> Selecionado = true, Modelo = Auto Detect
                    
                    let isSelected = true;
                    let modelToUse = detectDefaultModel(category);

                    if (hasSavedData) {
                        if (savedGroup) {
                            isSelected = true;
                            modelToUse = savedGroup.type; // Recupera a escolha do usu√°rio (ex: Beam em vez de Truss)
                        } else {
                            isSelected = false;
                        }
                    }

                    loadedGroups.push({
                        name: groupName,
                        selected: isSelected,
                        count: info.count,
                        composition: compStr,
                        category: category, 
                        model: modelToUse, 
                        phenomenon: 'MECANIQUE'        
                    });
                });
            }
            setGroups(loadedGroups);
        } catch (err) {
            if(!err.message.includes("n√£o encontrado")) console.error(err);
            setError("No inspection data found. Run MESH analysis first.");
        } finally {
            setLoading(false);
        }
    };    


    // --- HANDLERS ---
    const handleCheckboxChange = (index) => {
        const newGroups = [...groups];
        newGroups[index].selected = !newGroups[index].selected;
        setGroups(newGroups);
    };

    const handleModelChange = (index, newModel) => {
        const newGroups = [...groups];
        newGroups[index].model = newModel;
        setGroups(newGroups);
    };

    const toggleAll = (select) => {
        const newGroups = groups.map(g => ({ ...g, selected: select }));
        setGroups(newGroups);
    };

    // --- RENDER ---
    if (!projectPath) return <div className="p-10 text-center text-slate-500">Please select a project.</div>;

    if (loading) return (
        <div className="flex flex-col items-center justify-center h-64 text-blue-400 animate-pulse">
            <div className="text-4xl mb-2">üì°</div>
            <p>Loading Mesh Data...</p>
        </div>
    );

    if (error || groups.length === 0) {
        return (
            <div className="flex flex-col items-center justify-center h-full p-10 text-slate-400">
                <div className="text-4xl mb-4 text-slate-600">üï∏Ô∏è</div>
                <h3 className="text-xl font-bold text-slate-300 mb-2">No Mesh Groups Detected</h3>
                <p className="mb-6 text-center max-w-md text-sm">{error}</p>
                <button 
                    onClick={loadMeshGroups}
                    className="px-6 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded transition-colors border border-slate-600 text-sm"
                >
                    Refresh Data
                </button>
            </div>
        );
    }

    return (
        <div className="flex flex-col h-full w-full max-w-7xl mx-auto animate-in fade-in duration-500 p-2">
            
            {/* Header / Selection Tools (Local) */}
            <div className="flex justify-start items-center mb-4 bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                <div className="flex gap-2">
                    <button onClick={() => toggleAll(true)} className="px-3 py-1.5 text-xs font-semibold bg-slate-700 hover:bg-slate-600 border border-slate-600 rounded text-slate-200 transition-colors">
                        Check All
                    </button>
                    <button onClick={() => toggleAll(false)} className="px-3 py-1.5 text-xs font-semibold bg-slate-700 hover:bg-slate-600 border border-slate-600 rounded text-slate-200 transition-colors">
                        Uncheck All
                    </button>
                </div>
                <div className="ml-auto text-[10px] text-slate-500 uppercase font-bold tracking-wider">
                    Model Definition
                </div>
            </div>

            {/* Table */}
            <div className="bg-slate-800 border border-slate-700 rounded-lg overflow-hidden shadow-xl flex-1 flex flex-col">
                <div className="overflow-y-auto flex-1 custom-scrollbar">
                    <table className="w-full text-left border-collapse">
                        <thead className="bg-slate-950 text-slate-400 text-[10px] uppercase tracking-wider sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th className="p-3 w-12 text-center border-b border-slate-800">Sel.</th>
                                <th className="p-3 w-1/4 border-b border-slate-800">Group Name</th>
                                <th className="p-3 w-1/4 border-b border-slate-800">Composition</th>
                                <th className="p-3 w-1/4 border-b border-slate-800">Model Definition (Code_Aster)</th>
                            </tr>
                        </thead>

                        <tbody className="divide-y divide-slate-700/50 text-sm">
                            {groups.map((group, idx) => {  // <--- 1. ABRE CHAVES AQUI
                                
                                // Se for N√≥, esconde (retorna null)
                                if (group.category === 'Node' || group.category === 'Point') return null;

                                // 2. ADICIONE O 'return (' ANTES DO TR
                                return (
                                    <tr key={idx} className={`transition-colors hover:bg-slate-700/30 ${!group.selected ? 'opacity-50 grayscale-[50%]' : ''}`}>
                                        
                                        {/* Checkbox */}
                                        <td className="p-3 text-center">
                                            <input 
                                                type="checkbox" 
                                                checked={group.selected} 
                                                onChange={() => handleCheckboxChange(idx)}
                                                className="w-4 h-4 rounded border-slate-500 bg-slate-700 accent-blue-600 cursor-pointer"
                                            />
                                        </td>

                                        {/* Name */}
                                        <td className="p-3 font-mono font-medium text-blue-300">
                                            {group.name}
                                        </td>

                                        {/* Composition */}
                                        <td className="p-3 text-xs text-slate-400 font-mono">
                                            {group.composition}
                                        </td>

                                        {/* Filtered Selector */}
                                        <td className="p-3">
                                            <select 
                                                value={group.model} 
                                                onChange={(e) => handleModelChange(idx, e.target.value)}
                                                disabled={!group.selected}
                                                className="w-full bg-slate-900 border border-slate-600 rounded px-2 py-1.5 text-slate-200 text-xs focus:ring-1 focus:ring-blue-500 outline-none disabled:cursor-not-allowed transition-colors hover:border-slate-500"
                                            >
                                                {group.category === '3D' && (
                                                    <optgroup label="Volume (3D)">
                                                        {MODEL_OPTIONS['3D'].map(op => <option key={op.value} value={op.value}>{op.label}</option>)}
                                                    </optgroup>
                                                )}

                                                {group.category === '2D' && (
                                                    <optgroup label="Plate / Shell (2D)">
                                                        {MODEL_OPTIONS['2D'].map(op => <option key={op.value} value={op.value}>{op.label}</option>)}
                                                    </optgroup>
                                                )}

                                                {group.category === '1D' && (
                                                    <optgroup label="Beam / Truss (1D)">
                                                        {MODEL_OPTIONS['1D'].map(op => <option key={op.value} value={op.value}>{op.label}</option>)}
                                                    </optgroup>
                                                )}
                                            </select>
                                        </td>

                                    </tr>
                                ); // <--- 3. FECHA OS PARENTESES DO RETURN
                            })} {/* <--- 4. FECHA AS CHAVES E O MAP */}
                        </tbody>

                    </table>
                </div>
                
                {/* Footer */}
                <div className="bg-slate-950 p-2 border-t border-slate-800 text-[10px] text-slate-500 flex justify-between px-4">
                    <span>Detected Groups: {groups.length}</span>
                    <span>Selected: {groups.filter(g => g.selected).length}</span>
                </div>
            </div>
        </div>
    );
}

// Export global
window.ModelConfig = ModelConfig;

--- ARQUIVO: prosolve\RestrictionConfig.js ---
// =========================================================
// ARQUIVO: RestrictionConfig.js
// PATH: prosolve/RestrictionConfig.js
// =========================================================

const React = window.React || require('react');
const { useState, useEffect } = React;

const RestrictionConfig = () => {
    const [restrictions, setRestrictions] = useState([]);
    const [availableGroups, setAvailableGroups] = useState([]);
    const [selectedGroup, setSelectedGroup] = useState(null);

    // --- REGRAS DE NEG√ìCIO (Code_Aster) ---
    const LOGIC_MAPPING = {
        '2D': {
            type: 'FACE_IMPO',
            icon: '‚¨õ',
            label: 'FACE_IMPO',
            fields: ['DX', 'DY', 'DZ', 'DNOR']
        },
        '1D': {
            type: 'ARETE_IMPO',
            icon: 'üìè',
            label: 'ARETE_IMPO',
            fields: ['DX', 'DY', 'DZ', 'DTAN']
        },
        'Point': {
            type: 'DDL_IMPO',
            icon: 'üìç',
            label: 'DDL_IMPO',
            fields: ['DX', 'DY', 'DZ', 'DRX', 'DRY', 'DRZ']
        },
        'Node': {
            type: 'DDL_IMPO',
            icon: 'üìç',
            label: 'DDL_IMPO',
            fields: ['DX', 'DY', 'DZ', 'DRX', 'DRY', 'DRZ']
        }
    };

    // --- 1. SETUP INICIAL ---
// --- 1. CARREGAR E FILTRAR DADOS ---
    useEffect(() => {
        const loadRawData = async () => {
            let rawGroups = {};
            
            // Tenta pegar do cache global PRIMEIRO (Preenchido pelo ModelConfig ou Workspace)
            if (window.projectState?.meshAnalysis) {
                rawGroups = window.projectState.meshAnalysis;
            } else {
                // Se n√£o tiver no cache, busca no disco (Seguran√ßa)
                try {
                    const resp = await fetch('http://localhost:5000/api/read_mesh_groups', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folder_path: window.projectState?.projectPath })
                    });
                    const json = await resp.json();
                    if (json.status === 'success') rawGroups = json.data.groups;
                } catch (e) { console.error("Restriction load error", e); }
            }

            // Processa usando o CLASSIFICADOR GLOBAL
            const processedGroups = Object.entries(rawGroups)
                .map(([name, info]) => ({
                    name: name,
                    type: Object.keys(info.types).join(', '),
                    category: window.classifyMeshGroup(info.types) // <--- USA A L√ìGICA GLOBAL
                }))
                // FILTRO: Restrictions aceita tudo, MENOS volume 3D
                .filter(g => g.category !== '3D'); 

            setAvailableGroups(processedGroups);

            // Carrega restri√ß√µes salvas
            const savedRestrictions = window.projectState?.restrictions || [];
            setRestrictions(savedRestrictions);

            if (!selectedGroup && processedGroups.length > 0) {
                setSelectedGroup(processedGroups[0].name);
            }
        };

        loadRawData();
    }, []);




    // --- 2. SYNC COM ESTADO GLOBAL ---
    useEffect(() => {
        if (window.projectState) {
            window.projectState.restrictions = restrictions;
            // Compatibilidade legado
            window.projectState.ddl_impo = restrictions
                .filter(r => r.type === 'DDL_IMPO')
                .map(r => ({ name: r.name, group: r.group, params: r.params }));
        }
    }, [restrictions]);

    // --- HELPERS DE NOME √öNICO (CORE) ---
    
    // Gera um nome √∫nico baseado em um prefixo (ex: 'BC_Group' ou 'BC_Group_Copy')
    const generateUniqueName = (baseName, excludeId = null) => {
        let candidate = baseName;
        let counter = 1;
        
        // Verifica se o nome j√° existe na lista (excluindo o pr√≥prio ID se estiver editando)
        const nameExists = (name) => restrictions.some(r => r.name === name && r.id !== excludeId);

        // Se o nome base j√° existe ou √© vazio, come√ßa a adicionar sufixos
        if (baseName.trim() === '' || nameExists(candidate)) {
            // Remove sufixos num√©ricos anteriores para evitar BC_1_1_1
            const cleanBase = baseName.replace(/_\d+$/, ''); 
            candidate = `${cleanBase}_${counter}`;
            while (nameExists(candidate)) {
                counter++;
                candidate = `${cleanBase}_${counter}`;
            }
        }
        return candidate;
    };

    // --- HANDLERS ---

    const handleAddRestriction = () => {
        if (!selectedGroup) return;
        const groupInfo = availableGroups.find(g => g.name === selectedGroup);
        if (!groupInfo) return;

        const config = LOGIC_MAPPING[groupInfo.category] || LOGIC_MAPPING['1D'];
        const baseName = `BC_${selectedGroup}`;
        
        const newRest = {
            id: Date.now(),
            name: generateUniqueName(baseName), // Garante unicidade na cria√ß√£o
            type: config.type,
            group: selectedGroup,
            params: {}
        };
        
        setRestrictions([...restrictions, newRest]);
    };

    const handleCopyRestriction = (originalRest) => {
        const newName = generateUniqueName(`${originalRest.name}_copy`);
        
        const copy = {
            ...originalRest,
            id: Date.now(),
            name: newName,
            // Copia profunda dos params para evitar refer√™ncia cruzada
            params: { ...originalRest.params } 
        };

        setRestrictions([...restrictions, copy]);
    };

    const handleDelete = (id) => {
        setRestrictions(prev => prev.filter(r => r.id !== id));
    };

    // Atualiza enquanto digita (permite duplicado visualmente tempor√°rio)
    const handleNameChange = (id, val) => {
        setRestrictions(prev => prev.map(r => r.id === id ? { ...r, name: val } : r));
    };

    // VALIDA√á√ÉO R√çGIDA AO SAIR DO CAMPO (BLINDAGEM)
    const handleNameBlur = (id, currentName) => {
        const isDuplicate = restrictions.some(r => r.name === currentName && r.id !== id);
        const isEmpty = currentName.trim() === '';

        if (isDuplicate || isEmpty) {
            // Se for duplicado ou vazio, for√ßa um novo nome √∫nico imediatamente
            const safeName = generateUniqueName(isEmpty ? `BC_Constraint` : currentName, id);
            
            setRestrictions(prev => prev.map(r => 
                r.id === id ? { ...r, name: safeName } : r
            ));
        }
    };

    const updateParam = (id, paramKey, value) => {
        setRestrictions(prev => prev.map(r => {
            if (r.id !== id) return r;
            const newParams = { ...r.params };
            
            if (value === '' || value === null || value === undefined) {
                delete newParams[paramKey];
            } else {
                newParams[paramKey] = value;
            }
            return { ...r, params: newParams };
        }));
    };

    const toggleFix = (id, paramKey) => {
        const currentRest = restrictions.find(r => r.id === id);
        if (!currentRest) return;
        const currentVal = currentRest.params[paramKey];
        updateParam(id, paramKey, (currentVal !== undefined) ? '' : "0.0");
    };

    // --- RENDER HELPERS ---
    const getGroupIcon = (cat) => {
        if (cat === '2D') return '‚¨õ';
        if (cat === '1D') return 'üìè';
        return 'üìç';
    };

    const activeGroupInfo = availableGroups.find(g => g.name === selectedGroup);
    const currentGroupRestrictions = restrictions.filter(r => r.group === selectedGroup);
    const activeLogic = activeGroupInfo ? (LOGIC_MAPPING[activeGroupInfo.category] || LOGIC_MAPPING['1D']) : null;

    return (
        <div className="flex h-full w-full bg-slate-950 text-slate-200 text-sm overflow-hidden font-sans">
            
            {/* SIDEBAR */}
            <div className="w-60 border-r border-slate-800 bg-slate-950 flex flex-col shrink-0">
                <div className="h-10 border-b border-slate-800 flex items-center px-4 bg-slate-950/50">
                    <span className="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Target Groups</span>
                </div>
                
                <div className="flex-1 overflow-y-auto custom-scrollbar p-1 space-y-0.5">
                    {availableGroups.map((grp) => {
                        const count = restrictions.filter(r => r.group === grp.name).length;
                        const isSelected = selectedGroup === grp.name;
                        
                        return (
                            <div 
                                key={grp.name} 
                                onClick={() => setSelectedGroup(grp.name)}
                                className={`flex justify-between items-center px-3 py-2.5 rounded cursor-pointer border-l-2 transition-all ${
                                    isSelected 
                                    ? 'bg-slate-900 border-blue-500 text-white' 
                                    : 'bg-transparent border-transparent hover:bg-slate-900/50 text-slate-400'
                                }`}
                            >
                                <div className="flex items-center gap-2 overflow-hidden">
                                    <span className="opacity-70 text-xs">{getGroupIcon(grp.category)}</span>
                                    <span className={`text-xs truncate ${isSelected ? 'font-bold' : 'font-medium'}`}>{grp.name}</span>
                                </div>
                                {count > 0 && (
                                    <span className="text-[9px] font-bold px-1.5 py-0.5 bg-blue-900/30 text-blue-400 rounded-full">
                                        {count}
                                    </span>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>

            {/* √ÅREA PRINCIPAL */}
            <div className="flex-1 flex flex-col bg-slate-900">
                
                {activeGroupInfo ? (
                    <>
                        {/* HEADER */}
                        <div className="h-14 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900 shrink-0">
                            <div className="flex items-center gap-3">
                                <div className="w-8 h-8 flex items-center justify-center bg-slate-800 rounded border border-slate-700">
                                    {getGroupIcon(activeGroupInfo.category)}
                                </div>
                                <div>
                                    <h2 className="text-sm font-bold text-white leading-none">{activeGroupInfo.name}</h2>
                                    <div className="flex items-center gap-2 mt-0.5">
                                        <span className="text-[9px] text-blue-400 font-mono font-bold uppercase tracking-wider">{activeLogic.label}</span>
                                    </div>
                                </div>
                            </div>
                            <button 
                                onClick={handleAddRestriction}
                                className="bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded text-xs font-bold transition-all shadow-lg active:scale-95 flex items-center gap-2"
                            >
                                <span>+</span> Add Constraint
                            </button>
                        </div>

                        {/* LISTA */}
                        <div className="flex-1 overflow-y-auto p-4 custom-scrollbar bg-slate-900">
                            {currentGroupRestrictions.length === 0 ? (
                                <div className="h-40 flex flex-col items-center justify-center text-slate-600 opacity-60 border-2 border-dashed border-slate-800 rounded-lg m-4">
                                    <span className="text-2xl mb-2">‚öì</span>
                                    <p className="text-xs">No constraints. Group is free.</p>
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    {currentGroupRestrictions.map((rest) => {
                                        const fields = activeLogic.fields;
                                        // Verifica duplicidade apenas visualmente enquanto edita
                                        const isDuplicate = restrictions.some(r => r.name === rest.name && r.id !== rest.id);


// Arquivo: prosolve/RestrictionConfig.js

return (
    <div key={rest.id} className="bg-slate-950 border border-slate-800 rounded px-3 py-2 flex items-center gap-3 hover:border-slate-700 transition-colors shadow-sm group w-full">
        
        {/* 1. NOME (Um pouco mais largo para ler melhor) */}
        <div className="w-40 shrink-0 relative">
            <input 
                type="text" 
                className={`w-full bg-slate-900/50 border-b text-xs font-bold text-slate-200 outline-none px-1 py-1 transition-all ${isDuplicate ? 'border-red-500/80 text-red-200' : 'border-transparent hover:border-slate-600 focus:border-blue-500'}`}
                value={rest.name} 
                onChange={(e) => handleNameChange(rest.id, e.target.value)} 
                onBlur={(e) => handleNameBlur(rest.id, e.target.value)}
                placeholder="Condition Name"
                title="Must be unique" 
            />
            {isDuplicate && <span className="absolute right-0 top-1 text-[8px] text-red-500 font-bold animate-pulse">!</span>}
        </div>

        {/* 2. DIVISOR */}
        <div className="w-px h-6 bg-slate-800"></div>

        {/* 3. GRID DE CAMPOS (Largura aumentada: min-w-[70px]) */}
        <div className="flex-1 flex items-center gap-2 overflow-x-auto custom-scrollbar pb-1">
            {fields.map(field => {
                const val = rest.params[field];
                const isDefined = val !== undefined;
                const isSpecial = field === 'DNOR' || field === 'DTAN';

                return (
                    <div key={field} className={`flex items-center gap-2 px-2 py-1 rounded border min-w-[70px] transition-all ${isDefined ? 'bg-blue-900/10 border-blue-500/30' : 'bg-slate-900 border-slate-800 opacity-60 hover:opacity-100 hover:border-slate-600'}`}>
                        <button onClick={() => toggleFix(rest.id, field)} className={`text-[9px] font-bold uppercase w-6 text-left ${isSpecial ? 'text-purple-400' : 'text-slate-500'}`} title={isDefined ? "Click to Free" : "Click to Fix"}>{field}</button>
                        
                        {isDefined ? (
                            <input 
                                type="text" 
                                className="w-12 bg-transparent text-right text-[10px] font-mono text-white outline-none border-b border-blue-500/30 focus:border-blue-400 p-0 placeholder-slate-700"
                                value={val} 
                                placeholder="0.0" 
                                onChange={(e) => updateParam(rest.id, field, e.target.value)} 
                            />
                        ) : (
                            <span onClick={() => toggleFix(rest.id, field)} className="text-[9px] text-slate-600 cursor-pointer w-12 text-right select-none hover:text-slate-400">Free</span>
                        )}
                    </div>
                );
            })}
        </div>

        {/* 4. A√á√ïES */}
        <div className="flex items-center gap-1 border-l border-slate-800 pl-2">
            <button onClick={() => handleCopyRestriction(rest)} className="w-6 h-6 flex items-center justify-center text-slate-500 hover:text-blue-400 hover:bg-blue-500/10 rounded transition-colors" title="Duplicate">‚ùê</button>
            <button onClick={() => handleDelete(rest.id)} className="w-6 h-6 flex items-center justify-center text-slate-600 hover:text-red-400 hover:bg-red-500/10 rounded transition-colors" title="Delete">‚úï</button>
        </div>
    </div>
);




                                    })}
                                </div>
                            )}
                        </div>
                    </>
                ) : (
                    <div className="flex flex-col items-center justify-center h-full text-slate-500 bg-slate-900">
                        <p className="text-sm">Select a group to start</p>
                    </div>
                )}
            </div>
        </div>
    );
};

window.RestrictionConfig = RestrictionConfig;

--- ARQUIVO: prosolve\run_aster.py ---
import sys
import os
import subprocess

# --- CONFIGURA√á√ÉO ---
BASE_DIR = os.path.dirname(os.path.abspath(__file__))
CONFIG_FILE = os.path.join(BASE_DIR, "config.txt")

def carregar_config():
    """L√™ o arquivo config.txt e retorna um dicion√°rio"""
    configs = {}
    if not os.path.exists(CONFIG_FILE):
        print(f"[ERRO] Arquivo de configura√ß√£o n√£o encontrado: {CONFIG_FILE}")
        return configs
    
    try:
        with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                # Ignora linhas vazias ou coment√°rios
                if not line or line.startswith('#'):
                    continue
                if '=' in line:
                    key, value = line.split('=', 1)
                    configs[key.strip()] = value.strip()
    except Exception as e:
        print(f"[ERRO] Falha ao ler config.txt: {e}")
    
    return configs

def executar_simulacao():
    print("-" * 60)
    print("   WRAPPER DE EXECU√á√ÉO CODE_ASTER (PYTHON)")
    print("-" * 60)

    # 1. Carregar Configura√ß√µes
    config = carregar_config()
    aster_bin = config.get("ASTER_BIN")

    if not aster_bin:
        print("[ERRO] 'ASTER_BIN' n√£o definido no config.txt")
        return
    
    if not os.path.exists(aster_bin):
        print(f"[ERRO] Execut√°vel do Aster n√£o encontrado no caminho configurado:\n{aster_bin}")
        return

    # 2. Validar Argumentos
    if len(sys.argv) < 2:
        print("[ERRO] Caminho do arquivo export.export n√£o foi fornecido.")
        return

    export_path = sys.argv[1]

    if not os.path.exists(export_path):
        print(f"[ERRO] O arquivo export n√£o existe: {export_path}")
        return

    # 3. Definir Diret√≥rio de Trabalho
    working_dir = os.path.dirname(export_path)

    print(f"[INFO] Aster Bin: {aster_bin}")
    print(f"[INFO] Export:    {export_path}")
    print(f"[INFO] Executando Code_Aster...")

    try:
        # 4. Executar o Comando
        processo = subprocess.run(
            [aster_bin, export_path],
            cwd=working_dir,
            shell=True,
            capture_output=True,
            text=True
        )

        if processo.returncode == 0:
            print("\n[SUCESSO] O Code_Aster finalizou a execu√ß√£o.")
        else:
            print(f"\n[FALHA] O Code_Aster retornou c√≥digo de erro: {processo.returncode}")
            print("--- STDERR ---")
            print(processo.stderr)
            print("--- STDOUT ---")
            # print(processo.stdout[-1000:]) # Opcional: mostrar final do log

    except Exception as e:
        print(f"\n[CRITICO] Erro inesperado: {e}")

if __name__ == "__main__":
    executar_simulacao()

--- ARQUIVO: prosolve\StructuralWorkspace.js ---
const { useState, useEffect } = React;

// API Configuration
const API_BASE = 'http://localhost:5000/api';

// GLOBAL STATE MANAGER - Shared across all components
window.projectState = window.projectState || {
    simulationStatus: {
        Geometry: { ready: false, files: [] },
        Mesh: { ready: false, files: [] },
        Config: { ready: false, files: [] },
        PostPro: { ready: false, files: [] }
    },
    projectPath: null,
    geometries: [],
    materials: [],           // Defini√ß√µes (DEFI_MATERIAU)
    material_assignments: [], // Atribui√ß√µes (AFFE_MATERIAU)    

    updateSimulationStatus: function (newStatus) {
        this.simulationStatus = newStatus;
        // Trigger update on all listeners
        window.dispatchEvent(new Event('projectStateChanged'));
    }
};




// --- CLASSIFICADOR GLOBAL (A FONTE DA VERDADE) ---
window.classifyMeshGroup = (typesObj) => {
    if (!typesObj) return '3D'; // Seguran√ßa
    const types = Object.keys(typesObj);
    
    // 1. Prioridade absoluta para Node (vindo do inspect_mesh.j2)
    if (types.includes('Node')) return 'Node'; 
    
    // 2. Classifica√ß√£o de Elementos
    if (types.some(t => t.includes('HEXA') || t.includes('TETRA') || t.includes('PENTA'))) return '3D';
    if (types.some(t => t.includes('QUAD') || t.includes('TRIA'))) return '2D';
    if (types.some(t => t.includes('SEG'))) return '1D';
    if (types.some(t => t === 'Point' || t === 'POINT')) return 'Point';
    
    return '3D'; // Fallback
};



// COMPONENT: Simulation Console
const SimulationConsole = ({ status, logs }) => {
    if (status === 'IDLE' && !logs) return null;

    return (
        <div className="mt-8 space-y-4 animate-in slide-in-from-bottom duration-500 bg-slate-900 border-t border-slate-800 p-4">
            <div className="flex items-center justify-between">
                <h3 className="text-sm uppercase font-bold text-slate-400 tracking-widest flex items-center gap-2">
                    <span> Simulation Console</span>
                    {status === 'RUNNING' && <span className="w-2 h-2 bg-blue-500 rounded-full animate-ping"></span>}
                </h3>
                <div className="text-xs font-mono text-slate-500">
                    Status: <span className={
                        status === 'SUCCESS' ? 'text-green-500' :
                            status === 'FAILED' ? 'text-red-500' :
                                'text-blue-400'
                    }>{status}</span>
                </div>
            </div>

            <div className="bg-black/80 rounded-lg border border-slate-700 p-4 font-mono text-xs overflow-hidden shadow-2xl">
                <div className="max-h-64 overflow-y-auto scrollbar-thin scrollbar-thumb-slate-700 space-y-1">
                    {logs ? (
                        logs.split('\n').map((line, i) => (
                            <div key={i} className={`${line.includes('<F>') || line.includes('ERR') ? 'text-red-400' :
                                line.includes('<W>') ? 'text-amber-400' :
                                    line.includes('<S>') ? 'text-green-400' :
                                        'text-slate-300'
                                }`}>
                                <span className="text-slate-600 mr-2 opacity-50">[{i + 1}]</span>
                                {line}
                            </div>
                        ))
                    ) : (
                        <div className="text-slate-600 italic">Initializing Code_Aster engine...</div>
                    )}
                </div>
            </div>
        </div>
    );
};


function SimConfigPanel({ onRunSimulation }) {
    const [activeTab, setActiveTab] = useState('Mesh');
    const [meshFiles, setMeshFiles] = useState([]);
    const [loading, setLoading] = useState(false);
    
    // --- ESTADOS PARA SALVAMENTO ---
    const [autoSave, setAutoSave] = useState(true);
    const [isSaving, setIsSaving] = useState(false);
    const [lastSaved, setLastSaved] = useState(null);

    const ModelConfigComponent = window.ModelConfig;
    const tabs = ['Mesh', 'Model', 'Materials', 'Geometry', 'Restrictions', 'Loads', 'Load Cases'];

    // Listen for global state changes
    useEffect(() => {
        const handleStateChange = () => {
            const meshData = window.projectState?.simulationStatus?.Mesh?.files || [];
            setMeshFiles(meshData);
        };
        window.addEventListener('projectStateChanged', handleStateChange);
        // Initial state load
        handleStateChange();
        return () => window.removeEventListener('projectStateChanged', handleStateChange);
    }, []);




// --- FUN√á√ÉO SAVE PROJECT (O CONSTRUTOR DO JSON) ---
    const handleSaveProject = async () => {
        const projectPath = window.projectState.projectPath;
        if (!projectPath) {
            alert("Please select a project folder first.");
            return;
        }

        setIsSaving(true);
        const state = window.projectState;
        
        // Helper para limpar nomes (Code_Aster n√£o gosta de espa√ßos)
        const sanitize = (str) => str.trim().replace(/\s+/g, '_').toUpperCase();
        
        // Helper para converter string num√©rica em float
        const toFloat = (val) => parseFloat(val) || 0.0;

        try {
            // =========================================================
            // 1. PRE-PROCESS (MALHA)
            // =========================================================
            const meshFiles = state.simulationStatus.Mesh.files || [];
            const lireBlock = meshFiles.map((file, idx) => ({
                name: `MESH_${idx+1}`,
                filename: file,
                format: "MED"
            }));

            // =========================================================
            // 2. MODELO (F√çSICA)
            // =========================================================
            // Filtra 'Node' e 'Point' pois n√£o entram no AFFE_MODELE
            const modelItems = (state.geometries || [])
                .filter(g => g.category !== 'Node' && g.category !== 'Point')
                .map(g => {
                    let modelisation = '3D';
                    if (g.category === '1D') modelisation = 'POU_D_T'; // Viga Timoshenko padr√£o
                    if (g.category === '2D') modelisation = 'DKT';     // Casca DKT padr√£o
                    
                    return {
                        GROUP_MA: g.group,
                        PHENOMENE: 'MECANIQUE',
                        MODELISATION: modelisation
                    };
                });

            // =========================================================
            // 3. CARACTER√çSTICAS ELEMENTARES (GEOMETRIA)
            // =========================================================
            const caraItems = [];
            
            // 3.1 VIGAS (1D)
            const beams = (state.geometries || []).filter(g => g.category === '1D');
            if (beams.length > 0) {
                beams.forEach(b => {
                    // Aqui passamos os par√¢metros brutos. O Python vai calcular as propriedades (Area, Inercia)
                    // usando a lib sectionproperties se necess√°rio, ou passaremos direto se for simples.
                    // Para simplificar agora, passamos a defini√ß√£o da se√ß√£o.
                    caraItems.push({
                        TYPE: 'POUTRE',
                        GROUP_MA: b.group,
                        SECTION: 'RECTANGLE', // Simplifica√ß√£o: assumindo retangular por enquanto
                        CARA: ['HY', 'HZ'],
                        VALE: [toFloat(b.section_params?.hy || 0.1), toFloat(b.section_params?.hz || 0.1)],
                        ANGL_VRIL: toFloat(b.section_params?.rotation || 0.0)
                    });
                    // TODO: Implementar orienta√ß√£o (VECTEUR Y)
                });
            }

            // 3.2 CASCAS (2D)
            const shells = (state.geometries || []).filter(g => g.category === '2D');
            if (shells.length > 0) {
                shells.forEach(s => {
                    caraItems.push({
                        TYPE: 'COQUE',
                        GROUP_MA: s.group,
                        EPAIS: toFloat(s.section_params?.thickness || 0.01),
                        VECTEUR: [
                            toFloat(s.section_params?.vx || 1), 
                            toFloat(s.section_params?.vy || 0), 
                            toFloat(s.section_params?.vz || 0)
                        ],
                        EXCENTREMENT: toFloat(s.section_params?.offset || 0.0)
                    });
                });
            }

            // =========================================================
            // 4. MATERIAIS
            // =========================================================
            const defiMatBlock = (state.materials || []).map(m => ({
                NAME: sanitize(m.name),
                ELAS: {
                    E: toFloat(m.props.E),
                    NU: toFloat(m.props.NU),
                    RHO: toFloat(m.props.RHO)
                }
            }));

            const affeMatItems = (state.material_assignments || []).map(a => ({
                GROUP_MA: a.group,
                MATER: sanitize(a.material)
            }));

            // =========================================================
            // 5. CARGAS E RESTRI√á√ïES (CHARGES)
            // =========================================================
            const chargesBlock = [];

            // 5.1 Restri√ß√µes (DDL_IMPO)
            // Agrupa por nome da condi√ß√£o para criar blocos coesos
            const restrictions = state.restrictions || [];
            restrictions.forEach(r => {
                const params = {};
                // Mapeia inputs para floats, ignora vazios
                ['DX','DY','DZ','DRX','DRY','DRZ'].forEach(k => {
                    if (r.params[k] !== undefined) params[k] = toFloat(r.params[k]);
                });
                
                if (Object.keys(params).length > 0) {
                    chargesBlock.push({
                        NAME: sanitize(r.name),
                        TYPE: r.type, // 'DDL_IMPO', 'ARETE_IMPO'...
                        GROUP: r.group,
                        PARAMS: params
                    });
                }
            });

            // 5.2 Cargas (Loads)
            const loads = state.loads || [];
            loads.forEach(l => {
                const params = {};
                
                if (l.type === 'PESANTEUR') {
                    params.GRAVITE = toFloat(l.params.GRAV);
                    params.DIRECTION = [toFloat(l.params.DX), toFloat(l.params.DY), toFloat(l.params.DZ)];
                } 
                else if (l.type === 'FORCE_NODALE') {
                    // INTELIG√äNCIA 1: For√ßa Nodal Total
                    // Se o usu√°rio inseriu uma for√ßa total, dividimos pelo n√∫mero de n√≥s do grupo
                    const nodeCount = state.meshAnalysis?.[l.group]?.count || 1;
                    
                    ['FX','FY','FZ','MX','MY','MZ'].forEach(k => {
                        if (l.params[k]) params[k] = toFloat(l.params[k]) / nodeCount;
                    });
                }
                else if (l.type === 'FORCE_COQUE') {
                    // INTELIG√äNCIA 2: For√ßa na Face (Press√£o Equivalente)
                    // Aqui marcamos como CALC para o Python resolver a √°rea
                    // Mas salvamos os dados brutos
                    ['FX','FY','FZ'].forEach(k => {
                        if (l.params[k]) params[k] = toFloat(l.params[k]);
                    });
                }
                else if (l.type === 'PRES_REP') {
                     if (l.params.PRES) params.PRES = toFloat(l.params.PRES);
                }
                else {
                     // Gen√©rico (Beam Forces etc)
                     Object.keys(l.params).forEach(k => params[k] = toFloat(l.params[k]));
                }

                chargesBlock.push({
                    NAME: sanitize(l.name),
                    TYPE: l.type, // FORCE_NODALE, FORCE_COQUE...
                    GROUP: l.group,
                    PARAMS: params,
                    _META: { type: 'LOAD' } // Marcador para facilitar debug
                });
            });

            // =========================================================
            // 6. SOLVER (MECA_STATIQUE)
            // =========================================================
            const solverBlock = (state.load_cases || []).map(lc => {
                // Junta IDs de restri√ß√µes e cargas
                const excitNames = [...lc.restrictions, ...lc.loads].map(name => sanitize(name));
                
                return {
                    RESULTAT: `RESU_${sanitize(lc.name)}`,
                    EXCIT: excitNames.map(n => ({ CHARGE: n }))
                };
            });

            // =========================================================
            // 7. P√ìS-PROCESSAMENTO
            // =========================================================
            // Gera lista de resultados para exportar
            const outputResults = (state.load_cases || []).map(lc => ({
                RESULTAT: `RESU_${sanitize(lc.name)}`,
                NOM_CHAM: ['DEPL', 'SIEQ_ELNO', 'REAC_NODA', 'FORC_NODA']
            }));
            
            // TODO: Adicionar l√≥gica de camadas (SUP/INF) aqui se houver Shells

            // =========================================================
            // CONSOLIDA√á√ÉO FINAL (O PAYLOAD)
            // =========================================================
            const projectJson = {
                meta: {
                    generated_by: "ProSolve_Studio",
                    date: new Date().toISOString()
                },
                LIRE_MAILLAGE: lireBlock,
                ASSE_MAILLAGE: [{ OPERATION: 'SUPERPOSE', RESULTAT: 'MAIL' }], // Simplificado
                AFFE_MODELE: { MAILLAGE: 'MAIL', AFFE: modelItems },
                AFFE_CARA_ELEM: { MODELE: 'MODELE', ...caraItems }, // Precisa formatar melhor no builder python
                // Para simplificar o envio, mandamos arrays separados e o Python junta
                _CARA_ELEM_DATA: caraItems, 
                
                DEFI_MATERIAU: defiMatBlock,
                AFFE_MATERIAU: { MAILLAGE: 'MAIL', AFFE: affeMatItems },
                
                CHARGES: chargesBlock,
                
                MECA_STATIQUE: solverBlock,
                
                POST_PROCESS: {
                    IMPR_RESU: {
                        FORMAT: 'MED',
                        UNITE: 80,
                        RESU: outputResults
                    },
                    // Solicita exporta√ß√£o CSV das rea√ß√µes para todos os casos
                    EXPORT_REACTIONS: true 
                }
            };

            // Envio para o Backend (Salvar em disco)
            // Aqui usamos um endpoint gen√©rico save_file ou o endpoint espec√≠fico da simula√ß√£o
            // Vamos simular enviando para o endpoint de scan por enquanto, ou criar um novo.
            // O ideal √© salvar isso como 'project.json' na pasta do projeto.
            
            /* 
            // COMENTADO: Chamada real √† API quando o backend tiver o endpoint /save_project
            await fetch(`${API_BASE}/save_project`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ 
                    folder_path: projectPath, 
                    filename: 'project.json',
                    content: projectJson 
                })
            });
            */
           
            // Por enquanto, loga no console para verificarmos a estrutura
            console.log("üî• [PROJECT.JSON GENERATED] üî•");
            console.log(JSON.stringify(projectJson, null, 2));
            
            setLastSaved(new Date().toLocaleTimeString());

        } catch (e) {
            console.error("Save Error:", e);
            alert("Failed to build project data: " + e.message);
        } finally {
            setIsSaving(false);
        }
    };




    return (
        <div className="flex flex-col h-full animate-in fade-in slide-in-from-bottom-4 duration-500">
            {/*<h1 className="text-2xl font-light mb-6 border-b border-slate-800 pb-4">Simulation Configuration</h1>*/}

            {/* --- BARRA DE FERRAMENTAS (ABAS + BOT√ïES) --- */}
            <div className="flex border-b border-slate-800 mb-6 items-center justify-between gap-4 pb-0">
                
                {/* Abas (Esquerda) */}
                <div className="flex overflow-x-auto no-scrollbar">
                    {tabs.map(tab => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            className={`px-6 py-2 text-sm font-medium transition-colors border-b-2 whitespace-nowrap ${activeTab === tab
                                ? 'border-blue-500 text-blue-400 bg-blue-500/5'
                                : 'border-transparent text-slate-400 hover:text-slate-200 hover:bg-slate-800/50'
                                }`}
                        >
                            {tab}
                        </button>
                    ))}
                </div>

                {/* Bot√µes de A√ß√£o (Direita) */}
                <div className="flex items-center gap-3 bg-slate-900/50 pl-4 py-1 rounded-l-lg">
                    
                    {/* Status Info */}
                    <div className="text-[10px] text-slate-500 text-right mr-2 leading-tight hidden xl:block">
                        {isSaving ? <span className="text-blue-400 animate-pulse">Saving...</span> : 
                         lastSaved ? <span>Saved: {lastSaved}</span> : 
                         <span>Unsaved</span>}
                    </div>

                    {/* Auto Save Toggle */}
                    <div 
                        className="flex items-center gap-2 cursor-pointer group select-none mr-2" 
                        onClick={() => setAutoSave(!autoSave)}
                        title="Toggle Auto-Save"
                    >
                        <div className={`w-8 h-4 rounded-full p-0.5 transition-colors ${autoSave ? 'bg-emerald-600' : 'bg-slate-600'}`}>
                            <div className={`w-3 h-3 bg-white rounded-full shadow transition-transform ${autoSave ? 'translate-x-4' : 'translate-x-0'}`}></div>
                        </div>
                        <span className={`text-[10px] font-bold uppercase tracking-wider ${autoSave ? 'text-emerald-500' : 'text-slate-500'}`}>Auto</span>
                    </div>

                    {/* Save Project Button */}
                    <button
                        onClick={handleSaveProject}
                        disabled={isSaving}
                        className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-slate-200 text-xs font-bold rounded flex items-center gap-2 transition-colors border border-slate-600 shadow-sm active:scale-95"
                    >
                        <span>üíæ</span> SAVE PROJECT
                    </button>

                    {/* Run Button */}
                    <button
                        onClick={onRunSimulation}
                        className="mr-2 px-5 py-2 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white text-xs font-bold rounded-lg shadow-lg hover:shadow-emerald-500/20 transition-all flex items-center gap-2 group active:scale-95 border border-emerald-400/30"
                    >
                        <span className="group-hover:rotate-12 transition-transform">üöÄ</span>
                        RUN CODE_ASTER
                    </button>
                </div>
            </div>

            {/* Conte√∫do das Abas */}
            <div className="flex-1 overflow-y-auto">
                {activeTab === 'Mesh' && (
                    <div className="space-y-6">
                        <div className={`p-6 rounded-xl border-2 ${meshFiles?.length > 0
                            ? 'border-green-500 bg-green-500/10'
                            : 'border-amber-500 bg-amber-500/10'
                            }`}>
                            <div className="flex items-center gap-4">
                                <span className="text-3xl">{meshFiles?.length > 0 ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                                <div>
                                    <h3 className="font-bold text-lg">Mesh Files</h3>
                                    <p className="text-slate-300">
                                        {loading ? 'Scanning...' : meshFiles?.length > 0
                                            ? `Found ${meshFiles.length} mesh file(s)`
                                            : 'No Mesh Files Found'}
                                    </p>
                                </div>
                            </div>
                        </div>

                        {meshFiles?.length > 0 && (
                            <div className="bg-slate-800/50 p-6 rounded-xl border border-slate-700">
                                <h4 className="font-bold mb-4">Detected Mesh Files</h4>
                                <div className="space-y-2 max-h-96 overflow-y-auto custom-scrollbar">
                                    {meshFiles.map((file, idx) => (
                                        <div key={idx} className="flex items-center gap-3 p-3 bg-slate-700/50 rounded border border-slate-600 hover:bg-slate-600/50 transition-colors">
                                            <span className="text-lg">üìã</span>
                                            <span className="text-slate-200 text-sm font-mono">{file}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                )}

                {activeTab === 'Model' && ModelConfigComponent && (
                    <ModelConfigComponent 
                        meshFiles={meshFiles}
                    />
                )}

                {activeTab === 'Materials' && window.MaterialConfig && (
                    <window.MaterialConfig />
                )}


            {activeTab === 'Geometry' && (
                // APENAS UM CONTAINER QUE OCUPA TUDO (h-full w-full)
                // O componente interno GeometryConfig gerencia sua pr√≥pria largura (flex-1 vs flex-2)
                <div className="h-full w-full animate-in fade-in duration-500">
                    {window.GeometryConfig ? (
                        <window.GeometryConfig />
                    ) : (
                        <div className="flex flex-col items-center justify-center h-full text-red-400 p-4 text-center">
                            <p className="font-bold">GeometryConfig not loaded</p>
                        </div>
                    )}
                </div>
            )}



                {activeTab === 'Restrictions' && (
                    <div className="h-full w-full animate-in fade-in duration-500">
                        {window.RestrictionConfig ? (
                            <window.RestrictionConfig />
                        ) : (
                            <div className="flex flex-col items-center justify-center h-full text-slate-500">
                                <span className="text-4xl mb-4">‚ö†Ô∏è</span>
                                <p>RestrictionConfig.js not loaded.</p>
                                <p className="text-xs mt-2">Check structural.html script tags.</p>
                            </div>
                        )}
                    </div>
                )}



                {activeTab === 'Loads' && (
                    <div className="h-full w-full animate-in fade-in duration-500">
                        {window.LoadConfig ? (
                            <window.LoadConfig />
                        ) : (
                            <div className="flex flex-col items-center justify-center h-full text-slate-500">
                                <span className="text-4xl mb-4">‚ö†Ô∏è</span>
                                <p>LoadConfig.js not loaded.</p>
                            </div>
                        )}
                    </div>
                )}



               {activeTab === 'Load Cases' && (
                    <div className="h-full w-full animate-in fade-in duration-500">
                        {window.LoadCaseConfig ? (
                            <window.LoadCaseConfig />
                        ) : (
                            <div className="flex flex-col items-center justify-center h-full text-slate-500">
                                <span className="text-4xl mb-4">‚ö†Ô∏è</span>
                                <p>LoadCaseConfig.js not loaded.</p>
                            </div>
                        )}
                    </div>
                )}



            </div>
        </div>
    );
}


function StructuralApp({ onBack, onToggleMaximize, projectPath, setProjectPath }) {
    const [activeView, setActiveView] = useState('Workflow');

    // Global Simulation State
    const [simStatus, setSimStatus] = useState('IDLE');
    const [simLogs, setSimLogs] = useState('');
    const [isPolling, setIsPolling] = useState(false);
    // Estado para controlar a visibilidade do console
    const [showConsole, setShowConsole] = useState(true);   

    // EFFECT: Polling logs if running
    useEffect(() => {
        let pollInterval;

        if (isPolling && projectPath) {
            console.log("[Global Polling] Starting log polling...");
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/get_logs`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ folder_path: projectPath })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setSimLogs(data.logs);
                        setSimStatus(data.status);

                        if (data.status === 'SUCCESS' || data.status === 'FAILED') {
                            console.log(`[Global Polling] Simulation ended with status: ${data.status}`);
                            setIsPolling(false);
                            // Force update global status for badges
                            window.simStatus = data.status; // Quick hack for shared state
                            window.dispatchEvent(new Event('simStatusChanged'));
                        }
                    }
                } catch (error) {
                    console.error("[Global Polling] Error fetching logs:", error);
                }
            }, 3000); // Poll every 3 seconds
        }

        return () => {
            if (pollInterval) clearInterval(pollInterval);
        };
    }, [isPolling, projectPath]);

    // Listener for workflow triggering simulation
    useEffect(() => {
        const handleStartSim = () => {
            console.log("[Workspace] Simulation started from workflow!");
            setSimStatus('RUNNING');
            setIsPolling(true);
        };
        window.addEventListener('startSimulation', handleStartSim);
        return () => window.removeEventListener('startSimulation', handleStartSim);
    }, []);



// FUNCTION: Launch External Tools
    const handleLaunch = async (toolName) => {
        console.log(`[Workspace] Attempting to launch: ${toolName}`);
        
        try {
            const response = await fetch(`${API_BASE}/launch_tool`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ tool_name: toolName })
            });

            const result = await response.json();

            if (response.ok && result.status === 'success') {
                console.log(`‚úÖ ${toolName} launched successfully`);
            } else {
                console.error(`‚ùå Failed to launch ${toolName}:`, result.message);
                alert(`Error launching ${toolName}: ${result.message}`);
            }
        } catch (error) {
            console.error(`‚ùå Network error launching ${toolName}:`, error);
            alert(`Could not connect to backend to launch ${toolName}. Check if main.pyw is running.`);
        }
    };




    const handleRunSimulation = async () => {
        if (!projectPath) return;

        console.log("Manual run triggered");
        // We re-scan to trigger the exact same pipeline in main.pyw
        try {
            await fetch(`${API_BASE}/scan_workspace`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ folder_path: projectPath })
            });
            // Trigger polling manually since we are the caller
            setSimStatus('RUNNING');
            setIsPolling(true);
        } catch (e) {
            alert("Error starting simulation: " + e);
        }
    };

    return (
        <div className="flex h-full w-full flex-col bg-slate-900 text-white font-sans overflow-hidden relative">
            {/* Top Bar - Now only containing navigation and module title, buttons handled by Shell */}
            <div className="h-12 bg-slate-950 flex items-center justify-between px-4 drag-region select-none shrink-0 border-b border-slate-800">
                <div className="flex items-center gap-4">
                    <button
                        onClick={onBack}
                        className="no-drag bg-slate-800 hover:bg-slate-700 text-xs px-3 py-1 rounded border border-slate-700 transition-colors"
                    >
                        ‚Üê Back to Suite
                    </button>
                    <span className="font-bold text-sm tracking-wider text-blue-400">STRUCTURAL WORKBENCH</span>
                </div>
                {/* Title bar buttons are now in the dashboard.html Shell */}
                <div className="w-24"></div>
            </div>

            <div className="flex flex-1 overflow-hidden h-full">
                {/* Sidebar */}
                <div className="w-20 bg-slate-950 flex flex-col items-center py-6 border-r border-slate-800 shrink-0">
                    <div
                        onClick={() => setActiveView('Workflow')    }
                        className={`w-12 h-12 flex items-center justify-center rounded-lg transition-colors cursor-pointer mb-6 no-drag group relative ${activeView === 'Workflow' ? 'bg-blue-600/20 text-blue-400 border border-blue-500/30' : 'hover:bg-slate-800 text-slate-500'
                            }`}
                        title="Main Pipeline"
                    >
                        <span className="text-2xl group-hover:scale-110 transition-transform">üìã</span>
                        <div className="absolute left-full ml-2 px-2 py-1 bg-slate-800 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50">Pipeline</div>
                    </div>

                    <div className="w-12 border-t border-slate-800 mb-6"></div>


                    <div
                        onClick={() => setActiveView('SimConfig')   }
                        className={`w-12 h-12 flex items-center justify-center rounded-lg transition-colors cursor-pointer mb-4 no-drag group relative ${activeView === 'SimConfig' ? 'bg-blue-600/20 text-blue-400 border border-blue-500/30' : 'hover:bg-slate-700 text-slate-500'
                            }`}
                        title="Sim Config"
                    >
                        <span className="text-2xl group-hover:scale-110 transition-transform">‚öôÔ∏è</span>
                        <div className="absolute left-full ml-2 px-2 py-1 bg-slate-800 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50">Sim Config</div>
                    </div>


                    <div onClick={() => handleLaunch('FreeCAD')} className="w-12 h-12 flex items-center justify-center rounded-lg hover:bg-slate-700 transition-colors cursor-pointer mb-4 no-drag group relative" title="FreeCAD">
                        <span className="text-2xl group-hover:scale-110 transition-transform">üìê</span>
                        <div className="absolute left-full ml-2 px-2 py-1 bg-slate-800 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50">FreeCAD</div>
                    </div>

                    <div onClick={() => handleLaunch('Salome')} className="w-12 h-12 flex items-center justify-center rounded-lg hover:bg-slate-700 transition-colors cursor-pointer mb-4 no-drag group relative" title="Salome Meca">
                        <span className="text-2xl group-hover:scale-110 transition-transform">üï∏Ô∏è</span>
                        <div className="absolute left-full ml-2 px-2 py-1 bg-slate-800 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50">Salome Meca</div>
                    </div>

                    <div onClick={() => handleLaunch('Paraview')} className="w-12 h-12 flex items-center justify-center rounded-lg hover:bg-slate-700 transition-colors cursor-pointer mb-4 no-drag group relative" title="Paraview">
                        <span className="text-2xl group-hover:scale-110 transition-transform">üìä</span>
                        <div className="absolute left-full ml-2 px-2 py-1 bg-slate-800 rounded text-xs opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50">Paraview</div>
                    </div>
                </div>

                {/* Main Area */}
                <div className="flex-1 flex flex-col overflow-hidden bg-slate-900 pointer-events-auto relative">
                    <div className="flex-1 overflow-y-auto p-8 pointer-events-auto relative">
                        {activeView === 'Workflow' ? (
                            <div className="animate-in fade-in slide-in-from-right-4 duration-500 pb-20">
                                {/*<h1 className="text-2xl font-light mb-8 border-b border-slate-800 pb-4">Structural Analysis Pipeline</h1>*/}
                                <window.StructuralWorkflow
                                    onProjectChange={(path) => setProjectPath(path)}
                                    externalPath={projectPath}
                                    globalSimStatus={simStatus}
                                />
                            </div>
                        ) : (
                            <div className="pb-20">
                                <SimConfigPanel onRunSimulation={handleRunSimulation} />
                            </div>
                        )}
                    </div>

                    {/* Global Simulation Console - Always Visible at Bottom */}
                    <div className={`shrink-0 z-50 max-h-80 overflow-hidden bg-slate-900 border-t border-slate-800 shadow-2xl transition-all duration-300 ${showConsole ? '' : 'hidden'}`}>
                        <SimulationConsole status={simStatus} logs={simLogs} />
                    </div>
                    
                    {/* Bot√£o de Toggle - L√≥gica ONCLICK aplicada aqui */}
                    <button 
                        type="button"
                        onClick={() => setShowConsole(!showConsole)}
                        className="absolute bottom-2 right-2 z-50 bg-white/80 backdrop-blur-sm border border-gray-200 hover:bg-gray-100 rounded-lg p-2 shadow-md transition-all cursor-pointer"
                        title={showConsole ? "Hide Console" : "Show Console"}
                    >
                        <div className="flex items-center justify-center w-6 h-6">
                            {/* √çcone muda dependendo se est√° aberto ou fechado */}
                            <span className="text-gray-700 text-lg font-bold">
                                {showConsole ? '‚Üì' : '‚Üë'}
                            </span>
                        </div>
                    </button>

                </div>
            </div>
        </div>
    );
}

window.StructuralWorkspace = StructuralApp;

// Global exposure
window.StructuralApp = StructuralApp;


--- ARQUIVO: prosolve\_sectionproperties.py ---


--- ARQUIVO: prosolve\jinja\AsterButton.js ---
const AsterButton = ({ restrictions = [], loadedFiles = [], loads = [], loadCases = [], geometries = [] }) => {
    const handleRunCodeAster = () => {
        // Build mesh.json data
        const meshData = {
            unit_start: 80,
            meshes: loadedFiles.map(filename => ({
                name: filename.replace(/\.med$/i, ''),
                format: 'MED'
            }))
        };

        // Filter Node groups only and build ddl_impo format
        const ddlImpo = restrictions
            .filter(r => r.type === 'Node')
            .map(r => {
                const params = {};
                if (r.dx !== 'Free' && r.dx !== '') params.DX = parseFloat(r.dx) || 0.0;
                if (r.dy !== 'Free' && r.dy !== '') params.DY = parseFloat(r.dy) || 0.0;
                if (r.dz !== 'Free' && r.dz !== '') params.DZ = parseFloat(r.dz) || 0.0;
                if (r.mx !== 'Free' && r.mx !== '') params.DRX = parseFloat(r.mx) || 0.0;
                if (r.my !== 'Free' && r.my !== '') params.DRY = parseFloat(r.my) || 0.0;
                if (r.mz !== 'Free' && r.mz !== '') params.DRZ = parseFloat(r.mz) || 0.0;
                return { name: r.name, group: r.group, params };
            });

        // Build pesanteur.json data from all loads in the LOAD tab
        const pesanteurData = {
            pesanteur: loads.map(l => ({
                gravite: l.gravite || 9.81,
                direction: [
                    l.dirX || 0,
                    l.dirY || 0,
                    l.dirZ || -1
                ],
                group_ma: l.group_ma || '',
                name: l.name
            }))
        };

        // Build load_cases.json data
        const loadCasesData = {
            load_cases: loadCases.map(lc => ({
                name: lc.name,
                loads: lc.items
            }))
        };

        const payload = {
            mesh: meshData,
            ddl_impo: ddlImpo,
            pesanteur: pesanteurData,
            load_cases: loadCasesData,
            geometries: geometries // New geometry data
        };

        fetch('/run-aster', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).catch(() => alert("‚ùå Servidor n√£o encontrado."));
    };

    return React.createElement(
        "div",
        { className: "fixed bottom-6 right-6" },
        React.createElement(
            "button",
            {
                onClick: handleRunCodeAster,
                className: "bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-full shadow-lg flex items-center gap-2 transition-all transform hover:scale-105 active:scale-95 z-50",
                title: "Executar Code_Aster"
            },
            React.createElement("span", null, "‚ñ∂Ô∏è"),
            " Run Code_Aster"
        )
    );
};

export default AsterButton;



--- ARQUIVO: prosolve\jinja\generate_comm.py ---
# =========================================================
# generate_comm.py
# Gera arquivo .comm do Code_Aster a partir de JSON + Jinja
# =========================================================

import json
import sys
from pathlib import Path
from jinja2 import Environment, FileSystemLoader

# ---------------------------------------------------------
# 1. Configura√ß√£o de Diret√≥rios
# ---------------------------------------------------------
BASE_DIR = Path(__file__).resolve().parent

BUILDERS_DIR = BASE_DIR / "builders"
TEMPLATES_DIR = BASE_DIR / "templates"
STUDY_DIR = BASE_DIR / "study"
OUTPUT_DIR = BASE_DIR / "output"

# ---------------------------------------------------------
# 2. Importa√ß√£o de Builders
# ---------------------------------------------------------
sys.path.insert(0, str(BUILDERS_DIR))

try:
    from asse_maillage import build_asse_maillage
    from affe_modele import build_affe_modele
    from defi_materiau import build_defi_materiau
    from affe_materiau import build_affe_materiau
    from affe_cara_elem_shell import build_affe_cara_elem_shell
    # IMPORTA√á√ÉO ESPEC√çFICA PARA DDL
    from affe_char_meca_ddl import build_affe_char_meca_ddl 
    # IMPORTA√á√ÉO MECA_STATIQUE
    from meca_statique import build_meca_statique
    # IMPORTA√á√ÉO PESANTEUR
    from pesanteur import build_pesanteur
    # IMPORTA√á√ÉO LOAD CASES
    from load_cases import build_load_cases
    # IMPORTA√á√ÉO FORCE_COQUE
    from force_coque import build_force_coque
    # IMPORTA√á√ÉO POST_ELEM_MASS
    from post_elem_mass import build_post_elem_mass
    # IMPORTA√á√ÉO POST_RELEVE_T_REACTIONS
    from post_releve_t_reactions import build_post_releve_t_reactions
    from geometry import build_geometry
except ImportError as e:
    raise ImportError(f"Erro ao importar builders: {e}")

# ---------------------------------------------------------
# 3. Leitura dos Arquivos de Configura√ß√£o (JSON)
# ---------------------------------------------------------

# A. Mesh
mesh_file = STUDY_DIR / "mesh.json"
if not mesh_file.exists(): raise FileNotFoundError("mesh.json")
with open(mesh_file, encoding="utf-8") as f: mesh_config = json.load(f)
mesh_names = [m["name"] for m in mesh_config["meshes"]]

# B. Models
# C. Materials Props
materials_file = STUDY_DIR / "materials.json"
mat_props_list = []
if materials_file.exists():
    with open(materials_file, encoding="utf-8") as f: mat_props_list = json.load(f).get("materials", [])

# D. Material Assignments
assign_file = STUDY_DIR / "material_assignments.json"
assign_list = []
if assign_file.exists():
    with open(assign_file, encoding="utf-8") as f: assign_list = json.load(f).get("assignments", [])

# E. Geometry Properties (Unified Shell, Beam, Volume)
geom_file = STUDY_DIR / "geometry.json"
geometry_list = []
if geom_file.exists():
    with open(geom_file, encoding="utf-8") as f: 
        geometry_list = json.load(f).get("geometries", [])
else:
    # Fallback to old models.json if geometry.json doesn't exist (compatibility)
    models_file = STUDY_DIR / "models.json"
    if models_file.exists():
        with open(models_file, encoding="utf-8") as f:
            old_models = json.load(f).get("models", [])
            for m in old_models:
                geometry_list.append({"group": m["group"], "type": "Shell" if m["type"]=="DKT" else "Solid"})
    
    # Fallback to old shell_properties.json for thickness
    shells_file = STUDY_DIR / "shell_properties.json"
    if shells_file.exists():
        with open(shells_file, encoding="utf-8") as f:
            old_shells = json.load(f).get("shells", [])
            for s in old_shells:
                for target in geometry_list:
                    if target["group"] == s["group"]:
                        target["thickness"] = s["thickness"]

# F. DDL IMPO (JSON Espec√≠fico)
ddl_file = STUDY_DIR / "ddl_impo.json"
ddl_list = []
if ddl_file.exists():
    with open(ddl_file, encoding="utf-8") as f: 
        ddl_list = json.load(f).get("ddl_impo", [])

# G. MECA_STATIQUE (JSON)
meca_file = STUDY_DIR / "meca_statique.json"
meca_config = {}
if meca_file.exists():
    with open(meca_file, encoding="utf-8") as f:
        meca_config = json.load(f)

# H. PESANTEUR (JSON)
pes_file = STUDY_DIR / "pesanteur.json"
pes_config = {}
if pes_file.exists():
    with open(pes_file, encoding="utf-8") as f:
        pes_config = json.load(f)

# I. LOAD CASES (JSON)
lc_file = STUDY_DIR / "load_cases.json"
lc_list = []
if lc_file.exists():
    with open(lc_file, encoding="utf-8") as f:
        lc_list = json.load(f).get("load_cases", [])

# J. FORCE_COQUE (JSON)
foc_file = STUDY_DIR / "force_coque.json"
foc_config = {}
if foc_file.exists():
    with open(foc_file, encoding="utf-8") as f:
        foc_config = json.load(f)

# K. POST_ELEM_MASS (JSON)
mass_file = STUDY_DIR / "post_elem_mass.json"
mass_config = {}
if mass_file.exists():
    with open(mass_file, encoding="utf-8") as f:
        mass_config = json.load(f)

# L. POST_RELEVE_T_REACTIONS (JSON)
reac_file = STUDY_DIR / "post_releve_t_reactions.json"
reac_config = {}
if reac_file.exists():
    with open(reac_file, encoding="utf-8") as f:
        reac_config = json.load(f)

# ---------------------------------------------------------
# 4. Prepara√ß√£o dos Dados (Builders)
# ---------------------------------------------------------

FINAL_MESH = "MAIL"
FINAL_MODEL = "MODELE"
FINAL_CHMAT = "CHAM_MATER"
FINAL_CARA = "CARA_ELEM"
FINAL_DDL = "CHARGE_DDL" # Nome espec√≠fico da carga de DDL
FINAL_RESU = "RESU_MECA"

# A. Assembly
asse_data = build_asse_maillage(mesh_names, result_name=FINAL_MESH)

# B & E. Geometry (Model + Properties)
geom_data = build_geometry(geometry_list, model_name=FINAL_MODEL, result_name=FINAL_CARA)
model_data = { "result_name": FINAL_MODEL, "mesh_name": FINAL_MESH, "items": geom_data["model_items"] }
# Add default phenomene
for item in model_data["items"]: item["phenomene"] = "MECANIQUE"

# C. Material Defini√ß√£o
defi_mat_data = build_defi_materiau(mat_props_list)

# D. Material Atribui√ß√£o
affe_mat_data = build_affe_materiau(assign_list, model_name=FINAL_MODEL, result_name=FINAL_CHMAT)

# F. DDL IMPO (Builder Espec√≠fico)
ddl_data = build_affe_char_meca_ddl(
    ddl_list, 
    model_name=FINAL_MODEL, 
    result_name=FINAL_DDL
)

# G. PESANTEUR (Builder) - Agora antes de MECA_STATIQUE
# Define nome para a carga de gravidade
FINAL_PES = "CHARGE_PES"
pes_data = build_pesanteur(pes_config, model_name=FINAL_MODEL, result_name=FINAL_PES)

# I. FORCE_COQUE (Builder)
# Retorna dados de calculo (Python) e dados de carga (Aster)
foc_calc_data, foc_load_data = build_force_coque(foc_config, model_name=FINAL_MODEL)
FINAL_FOC = foc_load_data.get("result_name", "CHARGE_FOC")

# L. POST_RELEVE_T_REACTIONS (Builder)
reac_data = build_post_releve_t_reactions(reac_config, ddl_list)

# H. LOAD CASES (Builder)
# Passamos config de meca, dados de pesanteur e ddl para valida√ß√£o
lc_data = build_load_cases(
    lc_list, 
    meca_config, 
    pes_data=pes_data, 
    ddl_data=ddl_data, 
    model_name=FINAL_MODEL,
    reaction_extraction_data=reac_data,
    foc_data=foc_load_data
)

# K. POST_ELEM_MASS (Builder)
mass_data = build_post_elem_mass(
    mass_config, 
    model_name=FINAL_MODEL, 
    field_mat_name=FINAL_CHMAT, 
    cara_elem_name=FINAL_CARA
)

# ---------------------------------------------------------
# 5. Configura√ß√£o Jinja
# ---------------------------------------------------------
env = Environment(loader=FileSystemLoader(str(TEMPLATES_DIR)), trim_blocks=True, lstrip_blocks=True)

try:
    tpl_lire = env.get_template("lire_maillage.j2")
    tpl_asse = env.get_template("asse_maillage.j2")
    tpl_inspect = env.get_template("inspect_mesh.j2") 
    tpl_model = env.get_template("affe_modele.j2")
    tpl_defi = env.get_template("defi_materiau.j2")
    tpl_affe = env.get_template("affe_materiau.j2")
    tpl_cara = env.get_template("affe_cara_elem.j2")
    # TEMPLATE ESPEC√çFICO
    tpl_ddl = env.get_template("affe_char_meca_ddl.j2") 
    tpl_meca = env.get_template("meca_statique.j2") # Ainda usado se precisar fallback ou single, mas load_cases usa o dele
    tpl_pes = env.get_template("pesanteur.j2")
    tpl_lc = env.get_template("load_cases.j2")
    tpl_foc_calc = env.get_template("force_coque_calc.j2")
    tpl_foc_load = env.get_template("force_coque_load.j2")
    tpl_mass = env.get_template("post_elem_mass.j2")
except Exception as e:
    raise RuntimeError(f"Erro template: {e}")

# ---------------------------------------------------------
# 6. Escrita do Arquivo .comm
# ---------------------------------------------------------
OUTPUT_DIR.mkdir(exist_ok=True)
comm_path = OUTPUT_DIR / "calcul.comm"

print(f"Gerando script...")

with open(comm_path, "w", encoding="utf-8") as f:
    f.write("DEBUT(LANG='FR')\n\n")

    # 1. LEITURA
    f.write("# --- 1. Leitura ---\n")
    for i, mesh in enumerate(mesh_config["meshes"]):
        f.write(tpl_lire.render(
            mesh_name=mesh["name"], 
            unit=mesh.get("unit", 20+i), 
            filename=mesh.get("filename", f"{mesh['name']}.med")
        ))
        f.write("\n")

    # 2. ASSEMBLY
    f.write("# --- 2. Assembly ---\n")
    if asse_data["mode"] == "ASSE":
        f.write(tpl_asse.render(**asse_data))
    elif asse_data["mode"] == "SINGLE":
        if asse_data['final_mesh'] != FINAL_MESH:
            f.write(f"{FINAL_MESH} = {asse_data['final_mesh']}\n")
    f.write("\n")


    # --- NOVO BLOCO: INSPE√á√ÉO E GERA√á√ÉO DE JSON ---
    f.write("# --- 2.1 Inspe√ß√£o da Malha e Gera√ß√£o de JSON ---\n")
    # Passamos 'MAIL' (ou o valor de FINAL_MESH) para o template saber qual objeto inspecionar
    f.write(tpl_inspect.render(mesh_variable=FINAL_MESH))
    f.write("\n")
    # -----------------------------------------------

    # 3. MODELO
    f.write("# --- 3. Modelo ---\n")
    if model_data["items"]:
        f.write(tpl_model.render(**model_data))
        f.write("\n")

    # 4. MATERIAL (DEFI)
    f.write("# --- 4. Defini√ß√£o de Materiais ---\n")
    if defi_mat_data:
        f.write(tpl_defi.render(definitions=defi_mat_data))
        f.write("\n")

    # 5. MATERIAL (AFFE)
    f.write("# --- 5. Atribui√ß√£o de Materiais ---\n")
    if affe_mat_data["items"]:
        f.write(tpl_affe.render(**affe_mat_data))
        f.write("\n")

    # 6. GEOMETRY PROPERTIES (Shells, Beams)
    f.write("# --- 6. Propriedades Geom√©tricas (Cascas, Vigas) ---\n")
    if geom_data["cara_items"]:
        f.write(tpl_cara.render(**geom_data))
        f.write("\n")

    # 6.b BLOCO DE C√ÅLCULO DE √ÅREA (FORCE_COQUE PRE-PROCESSAMENTO)
    if foc_calc_data:
        f.write("# --- 6.b C√°lculo de Pression Equivalente (Force/Area) ---\n")
        f.write(tpl_foc_calc.render(**foc_calc_data))
        f.write("\n")

    # 7. DDL IMPO
    f.write("# --- 7. Condi√ß√µes de Contorno (DDL_IMPO) ---\n")
    if ddl_data:
        f.write(tpl_ddl.render(commands=ddl_data))
        f.write("\n")
    else:
        f.write("# AVISO: Nenhuma condi√ß√£o DDL_IMPO definida.\n")

    # 9. PESANTEUR (Agora antes de MECA)
    f.write("# --- 9. Carga de Pesanteur ---\n")
    if pes_data:
        f.write(tpl_pes.render(commands=pes_data))
        f.write("\n")

    # 10. FORCE_COQUE
    f.write("# --- 10. Carga de Force Coque ---\n")
    if foc_load_data and foc_load_data.get("load_items"):
        f.write(tpl_foc_load.render(**foc_load_data))
        f.write("\n")

    # 9. MECA_STATIQUE (Itera√ß√£o por Load Case) via Template Load Cases
    if lc_data.get("runs"):
        f.write(tpl_lc.render(**lc_data))
        f.write("\n")

    # 11. POST-PROCESSING (MASS)
    if mass_data:
        f.write("# --- 11. Post-Processing (Mass) ---\n")
        f.write(tpl_mass.render(commands=mass_data))
        f.write("\n")

    f.write("FIN()\n")

print(f"Arquivo gerado: {comm_path}")

--- ARQUIVO: prosolve\jinja\inspect_mesh.py ---
import sys
import json
import os
from pathlib import Path
from jinja2 import Environment, FileSystemLoader

# --- CONFIGURA√á√ÉO DE CAMINHOS ---
# Localiza√ß√£o deste script: root/jinja/inspect_mesh.py
BASE_DIR = Path(__file__).resolve().parent
BUILDERS_DIR = BASE_DIR / "builders"
TEMPLATES_DIR = BASE_DIR / "templates"

# Valida√ß√£o de diret√≥rios essenciais
if not BUILDERS_DIR.exists():
    print(f"[ERROR] Diretorio de builders nao encontrado: {BUILDERS_DIR}")
    sys.exit(1)

if not TEMPLATES_DIR.exists():
    print(f"[ERROR] Diretorio de templates nao encontrado: {TEMPLATES_DIR}")
    sys.exit(1)

# Adiciona builders ao path do sistema para importa√ß√£o
sys.path.insert(0, str(BUILDERS_DIR))

try:
    from asse_maillage import build_asse_maillage
    # lire_maillage √© opcional importar se fizermos o loop manual, mas asse √© vital
except ImportError as e:
    print(f"[ERROR] Falha ao importar builders do Code_Aster: {e}")
    sys.exit(1)

def generate_inspection_comm(project_folder):
    """
    Orquestrador que l√™ o mesh.json e gera o arquivo de comando med.comm
    dentro da pasta simulation_files.
    """
    project_path = Path(project_folder)
    sim_files_path = project_path / "simulation_files"
    
    # ARQUIVO DE ENTRADA (Gerado pelo Python Main)
    mesh_json_path = sim_files_path / "mesh.json"
    
    # ARQUIVO DE SA√çDA (Onde o .comm ser√° salvo)
    output_comm = sim_files_path / "med.comm"

    print(f"[INSPECT] Gerando .comm para: {project_path}")
    print(f"[INSPECT] Arquivo de destino: {output_comm}")

    # 1. Ler o JSON de Input (mesh.json)
    if not mesh_json_path.exists():
        print(f"[ERROR] mesh.json nao encontrado em: {mesh_json_path}")
        return False

    try:
        with open(mesh_json_path, 'r', encoding='utf-8') as f:
            mesh_config = json.load(f)
    except Exception as e:
        print(f"[ERROR] Falha ao ler ou decodificar mesh.json: {e}")
        return False

    # 2. Configurar Jinja2
    env = Environment(loader=FileSystemLoader(str(TEMPLATES_DIR)), trim_blocks=True, lstrip_blocks=True)
    
    try:
        tpl_lire = env.get_template("lire_maillage.j2")
        tpl_asse = env.get_template("asse_maillage.j2")
        tpl_inspect = env.get_template("inspect_mesh.j2")
    except Exception as e:
        print(f"[ERROR] Erro ao carregar templates Jinja: {e}")
        return False

    # 3. Processar Dados
    unit_start = mesh_config.get("unit_start", 80)
    meshes_list = mesh_config.get("meshes", [])
    
    if not meshes_list:
        print("[ERROR] Nenhuma malha definida dentro de mesh.json")
        return False
    
    try:
        # Inicio do arquivo .comm
        comm_content = "DEBUT(LANG='FR')\n\n"
        comm_content += "# --- 1. Leitura das Malhas ---\n"

        mesh_names = []
        
        # Loop para gerar comandos LIRE_MAILLAGE
        for i, mesh in enumerate(meshes_list):
            unit = unit_start + i
            mesh_name = mesh["name"]
            mesh_names.append(mesh_name)
            
            # O nome do arquivo no .comm √© menos relevante se usarmos UNITE no export,
            # mas mantemos por consist√™ncia.
            filename = mesh.get("filename", f"{mesh_name}.med")
            
            # Renderiza template LIRE
            comm_content += tpl_lire.render(
                mesh_name=mesh_name,
                unit=unit,
                filename=filename
            ) + "\n"

        # Builder ASSE_MAILLAGE (Assembly)
        comm_content += "\n# --- 2. Assembly ---\n"
        asse_data = build_asse_maillage(mesh_names, result_name="MAIL")
        
        final_mesh_variable = "MAIL"
        
        # L√≥gica de renderiza√ß√£o do Assembly
        if asse_data["mode"] == "ASSE":
            # Se houver m√∫ltiplas malhas, usa o comando ASSE_MAILLAGE
            comm_content += tpl_asse.render(**asse_data)
            final_mesh_variable = "MAIL"
            
        elif asse_data["mode"] == "SINGLE":
            # Se for √∫nica, o nome final √© o nome da malha lida
            original_name = asse_data['final_mesh']
            
            # Cria alias MAIL = Mesh_Nome para padronizar o script de inspe√ß√£o
            if original_name != "MAIL":
                 comm_content += f"MAIL = {original_name}\n"
                 final_mesh_variable = "MAIL"
        
        comm_content += "\n"

        # 4. Inje√ß√£o do Script de Inspe√ß√£o (Gera mesh_groups.json)
        comm_content += "# --- 3. Inspecao e Geracao de JSON ---\n"
        
        # --- PREPARA√á√ÉO DO CAMINHO ABSOLUTO ---
        # Converte para string e substitui backslash por forward slash para evitar 
        # problemas de escape string no Python gerado (ex: \t, \n, \r)
        abs_output_folder = str(sim_files_path.absolute()).replace("\\", "/")
        
        # Passamos a vari√°vel output_folder para o template
        comm_content += tpl_inspect.render(
            mesh_variable=final_mesh_variable,
            output_folder=abs_output_folder
        )
        comm_content += "\n"

        comm_content += "FIN()\n"

        # 5. Salvar Arquivo med.comm final na pasta simulation_files
        # --- Encoding="latin-1" para compatibilidade com Code_Aster Windows ---
        with open(output_comm, "w", encoding="latin-1") as f:
            f.write(comm_content)
            
        print(f"[INSPECT] med.comm gerado com sucesso em: {output_comm}")
        return True

    except Exception as e:
        print(f"[ERROR] Falha na construcao do conteudo .comm: {e}")
        import traceback
        traceback.print_exc()
        return False

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Uso: python inspect_mesh.py <caminho_do_projeto>")
        sys.exit(1)
    
    folder_arg = sys.argv[1]
    success_status = generate_inspection_comm(folder_arg)
    
    # Retorna c√≥digo de sa√≠da para o subprocesso pai (main.pyw) capturar
    sys.exit(0 if success_status else 1)

--- ARQUIVO: prosolve\jinja\teste.py ---
from medcoupling import MEDFileMesh

print("MEDCoupling OK")


--- ARQUIVO: prosolve\jinja\builders\affe_cara_elem_shell.py ---
def build_affe_cara_elem_shell(shell_list, model_name="MODELE", result_name="CARA_ELEM"):
    """
    Constr√≥i a estrutura para AFFE_CARA_ELEM focada apenas em COQUE (Cascas).
    """
    items = []

    for item in shell_list:
        group = item["group"]
        thickness = item["thickness"]
        excentricity = item.get("excentricity", 0.0)
        # Vetor padr√£o para cascas
        vector = tuple(item.get("vector", [1.0, 0.0, 0.0]))

        items.append({
            "group": group,
            "epais": thickness,
            "vecteur": vector,
            "excentrement": excentricity,
            
            # Constantes fixas para este tipo de an√°lise
            "a_cis": 0.8333333,
            "coef_rigi_drz": 1e-05,
            "coque_ncou": 1,
            "iner_rota": "OUI",
            "modi_metrique": "NON"
        })

    return {
        "result_name": result_name,
        "model_name": model_name,
        "items": items
    }

--- ARQUIVO: prosolve\jinja\builders\affe_char_meca_ddl.py ---
def build_affe_char_meca_ddl(ddl_list, model_name="MODELE", result_name="CHARGE_DDL"):
    """
    Constr√≥i a estrutura para AFFE_CHAR_MECA focada EXCLUSIVAMENTE em DDL_IMPO.
    Retorna uma lista de dicion√°rios, um para cada comando individual.
    """
    commands = []
    order_keys = ["DRX", "DRY", "DRZ", "DX", "DY", "DZ"]

    for item in ddl_list:
        name = item.get("name", result_name)
        input_params = item.get("params", {})
        
        active_params = []
        for key in order_keys:
            if key in input_params:
                active_params.append((key, input_params[key]))

        commands.append({
            "name": name,
            "group": item["group"],
            "params": active_params,
            "model_name": model_name,
            "double_lagrange": "OUI",
            "info": 1,
            "veri_affe": "OUI",
            "veri_norm": "OUI"
        })

    return commands

--- ARQUIVO: prosolve\jinja\builders\affe_materiau.py ---
def build_affe_materiau(assignments_list, model_name="MODELE", result_name="CHMAT"):
    """
    Constr√≥i a estrutura para AFFE_MATERIAU baseada em um JSON de atribui√ß√µes.
    assignments_list: Lista de dicts { "material": "NOME", "groups": [...] }
    """
    items = []

    for item in assignments_list:
        raw_mat_name = item["material"]
        groups = item.get("groups", [])
        
        if not groups:
            continue
            
        # Reconstr√≥i o nome da vari√°vel igual ao DEFI (ex: ACIER -> M_ACIER)
        # Importante: A regra de nomea√ß√£o deve ser id√™ntica ao builder do DEFI
        safe_name = raw_mat_name.upper().replace(" ", "_")
        var_name = f"M_{safe_name}"

        items.append({
            "mater": var_name,
            "groups": groups
        })

    return {
        "result_name": result_name,
        "model_name": model_name,
        "items": items
    }

--- ARQUIVO: prosolve\jinja\builders\affe_modele.py ---
def build_affe_modele(models_list, mesh_name="MAIL", result_name="MODELE"):
    """
    Prepara os dados para o comando AFFE_MODELE.
    """
    items = []
    
    for model in models_list:
        # Aqui voc√™ pode adicionar l√≥gica extra, valida√ß√µes, etc.
        item = {
            "group": model["group"],
            "modelisation": model["type"],
            "phenomene": "MECANIQUE" # Padr√£o, mas poderia vir do JSON
        }
        items.append(item)

    return {
        "result_name": result_name,
        "mesh_name": mesh_name,
        "items": items
    }

--- ARQUIVO: prosolve\jinja\builders\asse_maillage.py ---
# =========================================================
# Builder: ASSE_MAILLAGE
# Junta N malhas em UMA
# =========================================================

def build_asse_maillage(mesh_names, result_name="MAIL"):
    if not isinstance(mesh_names, list):
        raise ValueError("mesh_names deve ser lista")

    if len(mesh_names) == 0:
        raise RuntimeError("FATAL ERROR: No mesh units defined.")

    # Se s√≥ uma malha, nem precisa ASSE_MAILLAGE
    if len(mesh_names) == 1:
        return {
            "mode": "SINGLE",
            "final_mesh": mesh_names[0],
            "result_name": mesh_names[0],
            "items": []
        }

    items = [{"mesh": m} for m in mesh_names]

    return {
        "mode": "ASSE",
        "result_name": result_name,
        "final_mesh": result_name,
        "items": items
    }


--- ARQUIVO: prosolve\jinja\builders\defi_materiau.py ---
def build_defi_materiau(materials_list):
    """
    Prepara os dados para o comando DEFI_MATERIAU.
    Retorna uma lista de dicion√°rios contendo var_name, E, NU e RHO.
    """
    definitions = []

    for mat in materials_list:
        # Sanitiza√ß√£o do nome para criar vari√°vel no Code_Aster
        # Ex: "Concrete C30" -> "M_CONCRETE_C30"
        clean_name = mat["name"].upper().replace(" ", "_")
        var_name = f"M_{clean_name}"

        props = mat.get("props", {})
        
        definitions.append({
            "var_name": var_name,
            "E": props.get("E"),
            "NU": props.get("NU"),
            "RHO": props.get("RHO")
        })

    return definitions

--- ARQUIVO: prosolve\jinja\builders\force_coque.py ---
def build_force_coque(config, model_name="MODELE"):
    """
    Constr√≥i dados para FORCE_COQUE com normaliza√ß√£o de √°rea.
    """
    foc_list = config.get("force_coque", [])
    if not foc_list:
        return {}, {} # Sem dados

    # 1. Configura√ß√£o para o loop de c√°lculo de √°rea (Python puro dentro do .comm)
    # Lista de tuplas: (nome, group_ma, total_force)
    press_config = []
    
    # 2. Configura√ß√£o para o comando AFFE_CHAR_MECA
    # Lista de items de carga
    load_items = []

    for item in foc_list:
        name = item["name"]
        group = item["group"]
        force = item["total_force"]
        direction = item.get("direction", "PRES") # Default PRES, or FX, FY, FZ...

        # Adiciona √† lista de c√°lculo
        press_config.append( (name, group, force) )

        # Constr√≥i o item de carga que vai usar o valor calculado
        # O valor calculado estar√° em press_lookup[name][1]
        # Sintaxe JINJA vai inserir isso
        load_items.append({
            "name": name,
            "group": group,
            "direction": direction,
            # Placeholder para o template saber que deve pegar do dict
            "lookup_key": name 
        })

    calc_data = {
        "model_name": model_name,
        "press_config": press_config,
        # Precisamos de uma lista de TODOS os grupos envolvidos para criar o campo dummy corretamente?
        # O script original usa 'all_groups_ma'. Vamos passar a lista de grupos usados aqui.
        "groups": list(set([item["group"] for item in foc_list]))
    }

    load_data = {
        "model_name": model_name,
        "result_name": "CHARGE_FOC",
        "load_items": load_items,
        "double_lagrange": "OUI",
        "info": 1,
        "veri_affe": "OUI"
    }

    return calc_data, load_data


--- ARQUIVO: prosolve\jinja\builders\geometry.py ---
def build_geometry(geometry_list, model_name="MODELE", result_name="CARA_ELEM"):
    """
    Unified builder for GEOMETRY.
    Processes Shells, Beams, and Volumes.
    Returns data for model assignment and element characteristics.
    """
    model_items = []
    cara_items = []

    for item in geometry_list:
        group = item["group"]
        element_type = item.get("type", "Solid").upper()

        if element_type == "SHELL":
            # Model assignment
            model_items.append({
                "group": group,
                "modelisation": item.get("formulation", "DKT").upper()
            })
            # Cara assignment
            cara_items.append({
                "type": "COQUE",
                "group": group,
                "epais": item.get("thickness", 1.0),
                "excentrement": item.get("offset", 0.0),
                "vecteur": f"({item.get('vx', 1.0)}, {item.get('vy', 0.0)}, {item.get('vz', 0.0)})"
            })

        elif element_type == "BEAM":
            # Model assignment
            model_items.append({
                "group": group,
                "modelisation": "POU_D_T"
            })
            # Cara assignment
            section = item.get("section", "RECTANGLE").upper()
            if section == "RECTANGLE":
                hy = item.get("hy", 1.0)
                hz = item.get("hz", 1.0)
                cara = "('HY', 'HZ')"
                vale = f"({hy}, {hz})"
            else: # CIRCLE
                r = item.get("r", 1.0)
                cara = "('R')"
                vale = f"({r})"
                
            cara_items.append({
                "type": "POUTRE",
                "group": group,
                "section": section,
                "cara": cara,
                "vale": vale
            })

        else: # SOLID / VOLUME
            model_items.append({
                "group": group,
                "modelisation": "3D"
            })

    return {
        "model_items": model_items,
        "cara_items": cara_items,
        "model_result_name": model_name,
        "cara_result_name": result_name
    }


--- ARQUIVO: prosolve\jinja\builders\lire_maillage.py ---
# =========================================================
# Builder: LIRE_MAILLAGE (Code_Aster)
# Responsabilidade:
# - Validar dados
# - Gerar corpo do comando
# - Calcular UNITE automaticamente
# =========================================================

def build_lire_maillages(meshes, unit_start):
    """
    meshes: lista de dicts com:
        - name   : nome do concept (obrigat√≥rio)
        - format : MED | ASTER (opcional, default MED)

    unit_start: inteiro (ex: 80)
    """

    if not isinstance(meshes, list) or not meshes:
        raise ValueError("meshes deve ser uma lista n√£o vazia")

    if not isinstance(unit_start, int):
        raise ValueError("unit_start deve ser inteiro")

    seen_names = set()
    maillages = []

    for idx, mesh in enumerate(meshes):
        if not isinstance(mesh, dict):
            raise ValueError("Cada mesh deve ser um dicion√°rio")

        name = mesh.get("name")
        format = mesh.get("format", "MED")

        if not name or not isinstance(name, str):
            raise ValueError("Cada mesh precisa de um 'name' v√°lido")

        if name in seen_names:
            raise ValueError(f"Nome de malha duplicado: {name}")
        seen_names.add(name)

        if format not in ("MED", "ASTER"):
            raise ValueError(
                f"Formato inv√°lido para {name}: {format}"
            )

        unite = unit_start + idx

        body_lines = [
            f"    FORMAT='{format}',",
            f"    UNITE={unite},",
        ]

        maillages.append({
            "name": name,
            "body": "\n".join(body_lines)
        })

    return maillages


--- ARQUIVO: prosolve\jinja\builders\load_cases.py ---
def build_load_cases(lc_list, meca_config, pes_data, ddl_data, model_name="MODELE", reaction_extraction_data=None, **kwargs):
    """
    Constr√≥i a lista de configura√ß√µes de Load Cases (MECA_STATIQUE).
    """
    # Lista de NOMES v√°lidos gerados pelos builds anteriores
    # ddl_data e pes_data s√£o agora listas de configura√ß√µes (cada uma tem 'name' ou 'result_name')
    valid_names = [d["name"] for d in ddl_data]
    
    if isinstance(pes_data, list):
        for p in pes_data:
            if "result_name" in p:
                valid_names.append(p["result_name"])
    elif pes_data and "result_name" in pes_data:
        # Fallback para objeto √∫nico
        valid_names.append(pes_data["result_name"])
    
    foc_data = kwargs.get("foc_data")
    if foc_data and "result_name" in foc_data:
        valid_names.append(foc_data["result_name"])

    meca_runs = []
    
    if not lc_list:
        # Fallback se n√£o houver LC, tenta usar o primeiro DDL dispon√≠vel ou avisa
        default_load = valid_names[0] if valid_names else "CHARGE_DDL"
        lc_list = [{"name": "MECA", "loads": [default_load]}]

    base_config = meca_config.get("meca_statique", {})

    for lc in lc_list:
        case_name = lc.get("name", "CASE")
        result_name = f"RESU_{case_name}"
        
        excit_list_lc = []
        for load_name in lc.get("loads", []):
            # Valida√ß√£o: se o nome existe nos loads gerados
            if load_name in valid_names:
                excit_list_lc.append({
                    "charge": load_name,
                    "type_charge": "FIXE_CSTE"
                })

        # Prepara dados para o template load_cases.j2
        meca_runs.append({
            "case_name": case_name,
            "result_name": result_name,
            "cara_elem": base_config.get("cara_elem", "CARA_ELEM"),
            "cham_mater": base_config.get("cham_mater", "CHAM_MATER"),
            "modele": model_name,
            "excit_list": excit_list_lc,
            "option": base_config.get("option", "SIEF_ELGA"),
            "solveur": base_config.get("solveur", {}),
            "info": base_config.get("info", 1),
            "reaction_extraction": reaction_extraction_data
        })

    return {
        "runs": meca_runs
    }


--- ARQUIVO: prosolve\jinja\builders\meca_statique.py ---
def build_meca_statique(config, result_name="RESU"):
    """
    Constr√≥i a estrutura para MECA_STATIQUE.
    """
    data = config.get("meca_statique", {})
    
    # Extrai listas e valores simples
    excit_list = data.get("excit", [])
    
    return {
        "result_name": result_name,
        "cara_elem": data.get("cara_elem"),
        "cham_mater": data.get("cham_mater"),
        "excit_list": excit_list,
        "modele": data.get("modele"),
        # Valores fixos/default conforme solicita√ß√£o
        "info": 1,
        "inst": 0.0,
        "option": "SIEF_ELGA",
        "solveur": {
            "acceleration": "AUTO",
            "elim_lagr": "LAGR2",
            "gestion_memoire": "AUTO",
            "low_rank_seuil": 0.0,
            "matr_distribuee": "NON",
            "methode": "MUMPS",
            "nb_rhs": 1,
            "nprec": 8,
            "pcent_pivot": 35,
            "posttraitements": "AUTO",
            "pretraitements": "AUTO",
            "reduction_mpi": 0,
            "renum": "AUTO",
            "resi_rela": 1e-06,
            "stop_singulier": "OUI",
            "type_resol": "AUTO"
        }
    }


--- ARQUIVO: prosolve\jinja\builders\pesanteur.py ---
def build_pesanteur(config, model_name="MODELE", result_name="CHARGE_PES"):
    """
    Constr√≥i a estrutura para uma lista de cargas de PESANTEUR em AFFE_CHAR_MECA.
    Retorna uma lista de configura√ß√µes, uma para cada comando.
    """
    pes_list = config.get("pesanteur", [])
    if not isinstance(pes_list, list):
        # Fallback para o formato antigo se necess√°rio (embora o novo JSON envie lista)
        if isinstance(pes_list, dict) and pes_list:
            pes_list = [pes_list]
        else:
            return []

    commands = []
    for item in pes_list:
        final_name = item.get("name", result_name)
        commands.append({
            "result_name": final_name,
            "model_name": model_name,
            "gravite": item.get("gravite", 9.81),
            "direction": tuple(item.get("direction", [0.0, 0.0, -1.0])),
            "group_ma": item.get("group_ma", None),
            "double_lagrange": "OUI",
            "info": 1,
            "veri_affe": "OUI",
            "veri_norm": "OUI"
        })

    return commands


--- ARQUIVO: prosolve\jinja\builders\post_elem_mass.py ---
def build_post_elem_mass(config, model_name="MODELE", field_mat_name="CHAM_MATER", cara_elem_name="CARA_ELEM"):
    """
    Builds data for POST_ELEM (MASS_INER) and IMPR_TABLE.
    """
    calculations = config.get("mass_calculations", [])
    
    commands = []
    for item in calculations:
        commands.append({
            "result_name": item.get("result_name", "tab_mass"),
            "model_name": model_name,
            "field_mat_name": field_mat_name,
            "cara_elem_name": cara_elem_name,
            "title": item.get("title", "Physical_Mass_Structure"),
            "unit": item.get("unit", 26),
            "format": item.get("format", "TABLEAU"),
            "separator": item.get("separator", ","),
            "export_title": item.get("export_title", "MASS")
        })
        
    return commands


--- ARQUIVO: prosolve\jinja\builders\post_releve_t_reactions.py ---
def build_post_releve_t_reactions(config, ddl_list):
    """
    Builds data for reaction extraction.
    Identifies which groups have constraints (from ddl_list).
    """
    reac_config = config.get("reaction_extraction", {})
    if not reac_config.get("enabled", False):
        return None

    # Get unique groups from ddl_list
    constrained_groups = list(set([item["group"] for item in ddl_list if "group" in item]))

    if not constrained_groups:
        return None

    return {
        "groups": constrained_groups,
        "unit": reac_config.get("unit", 26),
        "format": reac_config.get("format", "TABLEAU"),
        "separator": reac_config.get("separator", ","),
        "resultante": tuple(reac_config.get("extract_components", ["DX", "DY", "DZ"])),
        "moment": tuple(reac_config.get("moment_components", ["DRX", "DRY", "DRZ"]))
    }


--- ARQUIVO: prosolve\jinja\templates\affe_cara_elem.j2 ---
{{ cara_result_name }} = AFFE_CARA_ELEM(
    MODELE={{ model_result_name }},
    {% for item in cara_items %}
    {{ item.type }} = _F(
        GROUP_MA = '{{ item.group }}',
        {% if item.type == 'COQUE' %}
        EPAIS = {{ item.epais }},
        EXCENTREMENT = {{ item.excentrement }},
        VECTEUR = {{ item.vecteur }},
        INER_ROTA = 'OUI',
        {% elif item.type == 'POUTRE' %}
        SECTION = '{{ item.section }}',
        CARA = {{ item.cara }},
        VALE = {{ item.vale }},
        {% endif %}
    ),
    {% endfor %}
)


--- ARQUIVO: prosolve\jinja\templates\affe_cara_elem_shell.j2 ---
{{ result_name }} = AFFE_CARA_ELEM(
    MODELE={{ model_name }},
    INFO=1,
    COQUE=(
    {%- for item in items %}
        _F(
            GROUP_MA='{{ item.group }}',
            EPAIS={{ item.epais }},
            VECTEUR={{ item.vecteur }},
            EXCENTREMENT={{ item.excentrement }},
            A_CIS={{ item.a_cis }},
            COEF_RIGI_DRZ={{ item.coef_rigi_drz }},
            COQUE_NCOU={{ item.coque_ncou }},
            INER_ROTA='{{ item.iner_rota }}',
            MODI_METRIQUE='{{ item.modi_metrique }}'
        ),
    {%- endfor %}
    ),
);

--- ARQUIVO: prosolve\jinja\templates\affe_char_meca_ddl.j2 ---
{% for item in commands %}
{{ item.name }} = AFFE_CHAR_MECA(
    DDL_IMPO=_F(
    {%- for key, val in item.params %}
        {{ key }}={{ val }},
    {%- endfor %}
        GROUP_NO='{{ item.group }}'),
    DOUBLE_LAGRANGE='{{ item.double_lagrange }}',
    INFO={{ item.info }},
    MODELE={{ item.model_name }},
    VERI_AFFE='{{ item.veri_affe }}',
    VERI_NORM='{{ item.veri_norm }}',
);
{% endfor %}

--- ARQUIVO: prosolve\jinja\templates\affe_materiau.j2 ---
{{ result_name }} = AFFE_MATERIAU(
    MODELE={{ model_name }},
    AFFE=(
    {%- for item in items %}
        _F(
            GROUP_MA=({{ "'" + item.groups|join("', '") + "'" }}),
            MATER={{ item.mater }}
        ),
    {%- endfor %}
    ),
);

--- ARQUIVO: prosolve\jinja\templates\affe_modele.j2 ---
{{ result_name }} = AFFE_MODELE(
    MAILLAGE={{ mesh_name }},
    AFFE=(
    {%- for item in items %}
        _F(GROUP_MA='{{ item.group }}', PHENOMENE='{{ item.phenomene }}', MODELISATION='{{ item.modelisation }}'),
    {%- endfor %}
    ),
);

--- ARQUIVO: prosolve\jinja\templates\asse_maillage.j2 ---
{# 
    L√≥gica para N malhas:
    O Code_Aster ASSE_MAILLAGE funciona melhor de forma bin√°ria (1+1).
    Este loop pega a primeira malha f√≠sica e vai 'superpondo' as demais
    sequencialmente, acumulando tudo na vari√°vel definida em {{ result_name }}.
#}

{% set first_mesh = items[0].mesh %}

{% for item in items[1:] %}

{{ result_name }} = ASSE_MAILLAGE(
    {# Se for a primeira itera√ß√£o, une a Malha 0 com a Malha 1 #}
    {# Nas pr√≥ximas, une o Resultado Acumulado (MAIL) com a Malha Atual #}
    MAILLAGE_1 = {% if loop.first %}{{ first_mesh }}{% else %}{{ result_name }}{% endif %},
    
    MAILLAGE_2 = {{ item.mesh }},
    
    OPERATION = 'SUPERPOSE',
);

{% endfor %}

--- ARQUIVO: prosolve\jinja\templates\defi_materiau.j2 ---
{% for mat in definitions %}
{{ mat.var_name }} = DEFI_MATERIAU(
    ELAS=_F(
        E={{ mat.E }},
        NU={{ mat.NU }},
        RHO={{ mat.RHO }}
    )
);
{% endfor %}

--- ARQUIVO: prosolve\jinja\templates\export.j2 ---
P actions make_etude
P rep_trav {{ temp_path }}
P memory_limit 2048
P time_limit 900.0
P version stable
P ncpus 1
P mpi_nbcpu 1
P mode interactif
F comm {{ comm_path }} D 1
F mess {{ message_path }} R 6
R base {{ base_path }} R 0
{% for mesh in meshes %}
F mmed {{ mesh.path }} D {{ mesh.unit }}
{% endfor %}
{% if csv_path %}
F dat {{ csv_path }} R 26
{% endif %}

--- ARQUIVO: prosolve\jinja\templates\force_coque_calc.j2 ---
# -----------------------------------------------------------------------
# FORCE TO PRESSURE CONVERSION LOGIC
# -----------------------------------------------------------------------
# Dados de entrada populados pelo Jinja
PRESS_CONFIG = {{ press_config }}
GROUPS_CALC = {{ groups }}

# Cria materiais dummy para c√°lculo
M_CALC = DEFI_MATERIAU(ELAS=_F(E=1.0, NU=0.3, RHO=1.0))
FIELD_CALC = AFFE_MATERIAU(
    MODELE={{ model_name }}, 
    AFFE=(
        _F(GROUP_MA=GROUPS_CALC, MATER=M_CALC),
    )
)
CARA_CALC = AFFE_CARA_ELEM(
    MODELE={{ model_name }}, 
    COQUE=(
        _F(GROUP_MA=GROUPS_CALC, EPAIS=1.0),
    )
)

press_lookup = {}
print("INFO: --- CONVERTING PRESSURE LOADS ---")
for p_name, p_group, p_force in PRESS_CONFIG:
    # Calcula geometria (mass_iner retorna massa = area * rho(1) * epais(1) = area)
    tbl_geom = POST_ELEM(
        MODELE={{ model_name }}, 
        CHAM_MATER=FIELD_CALC, 
        CARA_ELEM=CARA_CALC, 
        MASS_INER=_F(GROUP_MA=(p_group,))
    )
    val_dict = tbl_geom.EXTR_TABLE().values()
    # 'MASSE' √© a chave usual para massa em POST_ELEM com MASS_INER
    # Verifica-se se √© MASSE ou outra coisa, mas MASS_INER gera MASSE.
    area_val = sum(val_dict['MASSE'])
    
    if area_val > 0.0:
        pressure_pa = p_force / area_val
        print(f"      Load '{p_name}' on '{p_group}': {pressure_pa:.2f} Pa (Force: {p_force}, Area: {area_val:.2f})")
        press_lookup[p_name] = (p_group, pressure_pa)
    else:
        print(f"WARNING: Area is zero for group {p_group}. Force {p_name} set to 0.")
        press_lookup[p_name] = (p_group, 0.0)


--- ARQUIVO: prosolve\jinja\templates\force_coque_load.j2 ---
{{ result_name }} = AFFE_CHAR_MECA(
    MODELE={{ model_name }},
    FORCE_COQUE=(
    {%- for item in load_items %}
        _F(
            GROUP_MA='{{ item.group }}',
            # Usa o valor calculado no Python (press_lookup[nome][1])
            {{ item.direction }}=press_lookup['{{ item.name }}'][1]
        ),
    {%- endfor %}
    ),
    DOUBLE_LAGRANGE='{{ double_lagrange }}',
    INFO={{ info }},
    VERI_AFFE='{{ veri_affe }}',
);


--- ARQUIVO: prosolve\jinja\templates\inspect_mesh.j2 ---
# -----------------------------------------------------------------------------
# 3. DIAGNOSTICO DETALHADO + EXPORTACAO JSON (INJETADO VIA JINJA)
# -----------------------------------------------------------------------------
import sys
import json
import os

def imprimir_na_tela(texto):
    """Forca a impressao no console"""
    sys.stdout.write(texto + "\n")
    sys.stdout.flush()

# Cabecalho da tabela no terminal
print("\n" + "="*90)
print(f"{'NOME DO GRUPO':<30} | {'TOTAL':<8} | {'COMPOSICAO (TIPO:QTD)'}")
print("="*90)

# Dicionario que vai guardar os dados para o JSON
dados_output = {
    "source_mesh": "Code_Aster_Inspection",
    "groups": {}
}

# 1. Pega lista de grupos da malha '{{ mesh_variable }}'
lista_grupos = {{ mesh_variable }}.getGroupsOfCells()
lista_grupos.sort()

for g_nome in lista_grupos:
    # 2. Pega IDs e quantidade
    elementos_ids = {{ mesh_variable }}.getCells(g_nome)
    total_elementos = len(elementos_ids)
    
    # 3. Conta tipos
    contagem_tipos = {}
    for elem_id in elementos_ids:
        tipo = {{ mesh_variable }}.getCellTypeName(elem_id)
        if tipo in contagem_tipos:
            contagem_tipos[tipo] += 1
        else:
            contagem_tipos[tipo] = 1
            
    # 4. Formata para o terminal
    lista_composicao = []
    for tipo, qtd in contagem_tipos.items():
        lista_composicao.append(f"{tipo}:{qtd}")
    str_composicao = ", ".join(lista_composicao)
    
    print(f"{g_nome:<30} | {total_elementos:<8} | {str_composicao}")
    
    # 5. Guarda no dicionario
    dados_output["groups"][g_nome] = {
        "count": total_elementos,
        "types": contagem_tipos
    }

# 6. Processamento de Grupos de NOS (Nodes)
lista_grupos_nos = {{ mesh_variable }}.getGroupsOfNodes()
lista_grupos_nos.sort()

for g_nome in lista_grupos_nos:
    # A API getNodes pede uma lista de nomes [g_nome]
    nos_ids = {{ mesh_variable }}.getNodes([g_nome])
    total_nos = len(nos_ids)
    
    # Formata para o terminal
    str_composicao = f"Node:{total_nos}"
    print(f"{g_nome:<30} | {total_nos:<8} | {str_composicao}")
    
    # Guarda no dicionario
    # O tipo 'Node' eh usado para o JS detectar corretamente na UI
    dados_output["groups"][g_nome] = {
        "count": total_nos,
        "types": {"Node": total_nos}
    }

print("="*90 + "\n")

# -----------------------------------------------------------------------------
# SALVANDO O MESH_GROUPS.JSON (CAMINHO ABSOLUTO INJETADO)
# -----------------------------------------------------------------------------
try:
    # A variavel output_folder e injetada pelo script Python inspect_mesh.py
    # Usamos string raw (r) para evitar problemas com barras
    pasta_destino = r"{{ output_folder }}"
    
    # Garante que a pasta existe (embora o Python main ja tenha criado)
    if not os.path.exists(pasta_destino):
        os.makedirs(pasta_destino)
    
    # Define o caminho completo do arquivo JSON
    caminho_json = os.path.join(pasta_destino, "mesh_groups.json")
    
    with open(caminho_json, 'w') as f:
        json.dump(dados_output, f, indent=4)
        
    imprimir_na_tela(f"[ASTER] Resultado da inspecao salvo em:\n{caminho_json}")

except Exception as e:
    imprimir_na_tela(f"[ERRO] Falha ao salvar mesh_groups.json: {e}")

--- ARQUIVO: prosolve\jinja\templates\lire_maillage.j2 ---
{{ mesh_name }} = LIRE_MAILLAGE(
    UNITE={{ unit }},
    FORMAT='MED',
    NOM_MED='{{ mesh_name }}'
);

--- ARQUIVO: prosolve\jinja\templates\load_cases.j2 ---
{% for run in runs %}
# --- An√°lise Mec√¢nica: {{ run.case_name }} ---
{{ run.result_name }} = MECA_STATIQUE(
    CARA_ELEM={{ run.cara_elem }},
    CHAM_MATER={{ run.cham_mater }},
    EXCIT=(
    {%- for excit in run.excit_list %}
        _F(CHARGE={{ excit.charge }}, TYPE_CHARGE='{{ excit.type_charge }}'),
    {%- endfor %}
    ),
    INFO={{ run.info }},
    MODELE={{ run.modele }},
    OPTION='{{ run.option }}',
    SOLVEUR=_F(
        {%- for key, val in run.solveur.items() %}
        {{ key }}={{ val|tojson if val is string else val }}, # Simplifica√ß√£o
        {%- endfor %}
    ),
);

{% if run.reaction_extraction %}
# --- Extra√ß√£o de Rea√ß√µes: {{ run.case_name }} ---
{{ run.result_name }} = CALC_CHAMP(reuse={{ run.result_name }},
                         RESULTAT={{ run.result_name }},
                         FORCE=('REAC_NODA',))

REAC_{{ run.case_name }} = POST_RELEVE_T(ACTION=_F(OPERATION='EXTRACTION',
                                          INTITULE='Reac_{{ run.case_name }}',
                                          RESULTAT={{ run.result_name }},
                                          NOM_CHAM='REAC_NODA',
                                          GROUP_NO=({% for g in run.reaction_extraction.groups %}'{{ g }}'{{ ', ' if not loop.last }}{% endfor %}),
                                          RESULTANTE={{ run.reaction_extraction.resultante }},
                                          MOMENT={{ run.reaction_extraction.moment }},
                                          POINT=(0,0,0)))

IMPR_TABLE(TABLE=REAC_{{ run.case_name }},
           UNITE={{ run.reaction_extraction.unit }},
           FORMAT='{{ run.reaction_extraction.format }}',
           SEPARATEUR='{{ run.reaction_extraction.separator }}',
           TITRE='REAC_{{ run.case_name }}')
{% endif %}
{% endfor %}


--- ARQUIVO: prosolve\jinja\templates\meca_statique.j2 ---
{{ result_name }} = MECA_STATIQUE(CARA_ELEM={{ cara_elem }},
                    CHAM_MATER={{ cham_mater }},
                    {% for item in excit_list %}
                    EXCIT=_F(CHARGE={{ item.charge }},
                             TYPE_CHARGE='{{ item.type_charge }}'),
                    {% endfor %}
                    INFO={{ info }},
                    INST={{ inst }},
                    MODELE={{ modele }},
                    OPTION='{{ option }}',
                    SOLVEUR=_F(ACCELERATION='{{ solveur.acceleration }}',
                               ELIM_LAGR='{{ solveur.elim_lagr }}',
                               GESTION_MEMOIRE='{{ solveur.gestion_memoire }}',
                               LOW_RANK_SEUIL={{ solveur.low_rank_seuil }},
                               MATR_DISTRIBUEE='{{ solveur.matr_distribuee }}',
                               METHODE='{{ solveur.methode }}',
                               NB_RHS={{ solveur.nb_rhs }},
                               NPREC={{ solveur.nprec }},
                               PCENT_PIVOT={{ solveur.pcent_pivot }},
                               POSTTRAITEMENTS='{{ solveur.posttraitements }}',
                               PRETRAITEMENTS='{{ solveur.pretraitements }}',
                               REDUCTION_MPI={{ solveur.reduction_mpi }},
                               RENUM='{{ solveur.renum }}',
                               RESI_RELA={{ solveur.resi_rela }},
                               STOP_SINGULIER='{{ solveur.stop_singulier }}',
                               TYPE_RESOL='{{ solveur.type_resol }}'))


--- ARQUIVO: prosolve\jinja\templates\pesanteur.j2 ---
{% for item in commands %}
{{ item.result_name }} = AFFE_CHAR_MECA(
    MODELE={{ item.model_name }},
    PESANTEUR=_F(
        GRAVITE={{ item.gravite }},
        DIRECTION={{ item.direction }},
        {%- if item.group_ma %}
        GROUP_MA='{{ item.group_ma }}',
        {%- endif %}
    ),
    DOUBLE_LAGRANGE='{{ item.double_lagrange }}',
    INFO={{ item.info }},
    VERI_AFFE='{{ item.veri_affe }}',
    VERI_NORM='{{ item.veri_norm }}',
);
{% endfor %}


--- ARQUIVO: prosolve\jinja\templates\post_elem_mass.j2 ---
{% for cmd in commands %}
{{ cmd.result_name }} = POST_ELEM(MODELE={{ cmd.model_name }}, 
                       CHAM_MATER={{ cmd.field_mat_name }}, 
                       CARA_ELEM={{ cmd.cara_elem_name }},
                       MASS_INER=_F(TOUT='OUI'), 
                       TITRE='{{ cmd.title }}')

IMPR_TABLE(TABLE={{ cmd.result_name }}, 
           UNITE={{ cmd.unit }}, 
           FORMAT='{{ cmd.format }}', 
           SEPARATEUR='{{ cmd.separator }}', 
           TITRE='{{ cmd.export_title }}')
{% endfor %}


