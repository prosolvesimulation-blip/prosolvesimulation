{% if runs %}
{% for run in runs %}
{% set shell_groups = cara_items | selectattr('type', 'equalto', 'COQUE') | map(attribute='group') | list %}
{% set beam_groups = cara_items | selectattr('type', 'equalto', 'POUTRE') | map(attribute='group') | list %}



{% if shell_groups %}
{{ run.result_name }} = CALC_CHAMP(reuse={{ run.result_name }},
                         RESULTAT={{ run.result_name }},
                         CONTRAINTE=('SIGM_ELNO',),
                         CRITERES=('SIEQ_ELNO',),
                         FORCE=('REAC_NODA', 'FORC_NODA'))



RESU_{{ run.case_name }}_INF = POST_CHAMP(RESULTAT={{ run.result_name }},
                                         GROUP_MA=({{ "'" + shell_groups|join("', '") + "'" }}),
                                         EXTR_COQUE=_F(NOM_CHAM='SIGM_ELNO', NUME_COUCHE=1, NIVE_COUCHE='INF'))

RESU_{{ run.case_name }}_INF = CALC_CHAMP(reuse=RESU_{{ run.case_name }}_INF,
                                         RESULTAT=RESU_{{ run.case_name }}_INF,
                                         CONTRAINTE=('SIGM_NOEU',),
                                         CRITERES=('SIEQ_NOEU',))



RESU_{{ run.case_name }}_MOY = POST_CHAMP(RESULTAT={{ run.result_name }},
                                         GROUP_MA=({{ "'" + shell_groups|join("', '") + "'" }}),
                                         EXTR_COQUE=_F(NOM_CHAM='SIGM_ELNO', NUME_COUCHE=1, NIVE_COUCHE='MOY'))

RESU_{{ run.case_name }}_MOY = CALC_CHAMP(reuse=RESU_{{ run.case_name }}_MOY,
                                         RESULTAT=RESU_{{ run.case_name }}_MOY,
                                         CONTRAINTE=('SIGM_NOEU',),
                                         CRITERES=('SIEQ_NOEU',))



RESU_{{ run.case_name }}_SUP = POST_CHAMP(RESULTAT={{ run.result_name }},
                                         GROUP_MA=({{ "'" + shell_groups|join("', '") + "'" }}),
                                         EXTR_COQUE=_F(NOM_CHAM='SIGM_ELNO', NUME_COUCHE=1, NIVE_COUCHE='SUP'))

RESU_{{ run.case_name }}_SUP = CALC_CHAMP(reuse=RESU_{{ run.case_name }}_SUP,
                                         RESULTAT=RESU_{{ run.case_name }}_SUP,
                                         CONTRAINTE=('SIGM_NOEU',),
                                         CRITERES=('SIEQ_NOEU',))



IMPR_RESU(FORMAT='MED',
          UNITE=8,
          RESU=(
              _F(RESULTAT={{ run.result_name }},
                 NOM_CHAM=('DEPL', 'REAC_NODA', 'FORC_NODA'),
                 NOM_CHAM_MED=('DEPL_{{ run.case_name }}', 'REAC_{{ run.case_name }}', 'FORC_{{ run.case_name }}')),
              _F(RESULTAT=RESU_{{ run.case_name }}_INF,
                 NOM_CHAM=('SIGM_NOEU', 'SIEQ_NOEU'),
                 NOM_CHAM_MED=('S_INF_{{ run.case_name }}', 'VM_INF_{{ run.case_name }}')),
              _F(RESULTAT=RESU_{{ run.case_name }}_MOY,
                 NOM_CHAM=('SIGM_NOEU', 'SIEQ_NOEU'),
                 NOM_CHAM_MED=('S_MID_{{ run.case_name }}', 'VM_MID_{{ run.case_name }}')),
              _F(RESULTAT=RESU_{{ run.case_name }}_SUP,
                 NOM_CHAM=('SIGM_NOEU', 'SIEQ_NOEU'),
                 NOM_CHAM_MED=('S_SUP_{{ run.case_name }}', 'VM_SUP_{{ run.case_name }}')),
          ))
{% elif beam_groups %}
{# Para vigas: usar SIPO_ELNO (tensao detalhada) e SIRO_ELEM (tensao max fibra) #}
{{ run.result_name }} = CALC_CHAMP(reuse={{ run.result_name }},
                         RESULTAT={{ run.result_name }},
                         CONTRAINTE=('SIPO_ELNO', 'SIRO_ELEM'),
                         FORCE=('REAC_NODA', 'FORC_NODA'))



IMPR_RESU(FORMAT='MED',
          UNITE=8,
          RESU=(
              _F(RESULTAT={{ run.result_name }},
                 NOM_CHAM=('DEPL', 'REAC_NODA', 'FORC_NODA'),
                 NOM_CHAM_MED=('DEPL_{{ run.case_name }}', 'REAC_{{ run.case_name }}', 'FORC_{{ run.case_name }}')),
              _F(RESULTAT={{ run.result_name }},
                 NOM_CHAM=('SIPO_ELNO', 'SIRO_ELEM'),
                 NOM_CHAM_MED=('SIPO_{{ run.case_name }}', 'SIRO_{{ run.case_name }}')),
          ))
{% else %}
{# Fallback para solidos 3D #}
{{ run.result_name }} = CALC_CHAMP(reuse={{ run.result_name }},
                         RESULTAT={{ run.result_name }},
                         CONTRAINTE=('SIGM_ELNO', 'SIGM_NOEU'),
                         CRITERES=('SIEQ_ELNO', 'SIEQ_NOEU'),
                         FORCE=('REAC_NODA', 'FORC_NODA'))



IMPR_RESU(FORMAT='MED',
          UNITE=8,
          RESU=(
              _F(RESULTAT={{ run.result_name }},
                 NOM_CHAM=('DEPL', 'REAC_NODA', 'FORC_NODA'),
                 NOM_CHAM_MED=('DEPL_{{ run.case_name }}', 'REAC_{{ run.case_name }}', 'FORC_{{ run.case_name }}')),
              _F(RESULTAT={{ run.result_name }},
                 NOM_CHAM=('SIGM_NOEU', 'SIEQ_NOEU'),
                 NOM_CHAM_MED=('SIGM_{{ run.case_name }}', 'SIEQ_{{ run.case_name }}')),
          ))
{% endif %}

{% endfor %}
{% endif %}
